<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canopy Schedule Builder</title>
<style>
*{box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#fafafa;margin:0;padding:20px}
.container{max-width:1400px;margin:auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h1{text-align:center;color:#4CAF50;margin:10px 0}
.controls{display:flex;gap:10px;margin:20px 0;flex-wrap:wrap;align-items:center}
.controls select,.controls button{padding:8px 15px;font-size:14px;border-radius:4px;border:2px solid #ddd}
.controls button{background:#4CAF50;color:white;border-color:#4CAF50;cursor:pointer;font-weight:600}
.controls button:hover{background:#45a049}
.controls button.secondary{background:#2196F3;border-color:#2196F3}
.controls button.secondary:hover{background:#0b7dda}
#status{text-align:center;padding:10px;margin:10px 0;border-radius:4px;font-weight:bold;display:none}
.status-success{background:#d4edda;color:#155724}
.status-error{background:#f8d7da;color:#721c24}
.tabs{display:flex;gap:5px;border-bottom:2px solid #ddd;margin:20px 0}
.tab{padding:12px 20px;background:#f0f0f0;border:none;cursor:pointer;font-size:15px;border-radius:8px 8px 0 0;font-weight:600}
.tab:hover{background:#e0e0e0}
.tab.active{background:white;color:#4CAF50;border-bottom:3px solid #4CAF50}
.tab-content{display:none}
.tab-content.active{display:block}
.schedule-table{width:100%;border-collapse:collapse;margin-top:10px}
.schedule-table th,.schedule-table td{border:1px solid #ddd;padding:8px;font-size:13px;vertical-align:top}
.schedule-table th{background:#4CAF50;color:white;font-weight:bold;text-align:center;position:sticky;top:0;z-index:10}
.time-col{font-weight:bold;background:#f8f9fa;text-align:center;white-space:nowrap}
.class-card{font-size:12px;padding:8px;margin:6px 0;border-left:4px solid #2196F3;background:#f7f7f7;border-radius:4px;cursor:pointer;transition:all 0.2s}
.class-card:hover{background:#e6f0ff;transform:translateX(2px)}
.class-card.selected{background:#e6f0ff;border-left-color:#003f9a;border-left-width:5px}
.class-card.full{opacity:0.5;background:#ffe0e0;border-left-color:#d32f2f;cursor:not-allowed}
.class-card.full:hover{transform:none}
.class-name{font-weight:bold;margin-bottom:4px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.class-info{font-size:11px;color:#666;margin-top:4px}
.class-desc{font-size:11px;color:#555;margin-top:6px;padding-top:6px;border-top:1px solid #ddd;display:none;line-height:1.4}
.class-card.expanded .class-desc{display:block}
.expand-icon{font-size:10px;color:#999}
.type-badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:bold;text-transform:uppercase}
.type-commitment{background:#ffcdd2;color:#c62828}
.type-drop-in{background:#c8e6c9;color:#2e7d32}
.type-private{background:#ffe0b2;color:#e65100}
.link-icon{font-size:14px;color:#2196F3}
input[type="checkbox"]{width:16px;height:16px;cursor:pointer;margin-right:6px}
.my-schedule-table{width:100%;border-collapse:collapse;table-layout:fixed}
.my-schedule-table th,.my-schedule-table td{border:1px solid #ddd;padding:10px;font-size:13px;height:80px;vertical-align:top}
.my-schedule-table th{background:#2196F3;color:white}
.my-schedule-card{background:#f0f7ff;padding:8px;margin:4px 0;border-left:3px solid #2196F3;border-radius:3px;min-height:60px}
.empty-state{text-align:center;padding:40px;color:#999;font-size:48px}
@media print{
.controls,.tabs,#allClasses{display:none!important}
#mySchedule{display:block!important}
}
@media (max-width:768px){
.controls{flex-direction:column}
.controls input,.controls button{width:100%}
.schedule-table{font-size:11px}
.class-card{font-size:11px;padding:6px}
}
</style>
</head>
<body>
<div class="container">
<h1>üå≥ Canopy Schedule Builder - Session 3</h1>

<div class="controls">
<select id="studentName" onchange="loadSchedule()" style="flex:1;min-width:200px;padding:8px 15px;font-size:14px;border-radius:4px;border:2px solid #ddd">
<option value="">-- Select Student Name --</option>
</select>
<button onclick="loadSchedule()">üì• Load Schedule</button>
<button onclick="saveSchedule()">üíæ Save Schedule</button>
<button class="secondary" onclick="window.print()">üñ®Ô∏è Print</button>
</div>

<div id="status"></div>

<div class="tabs">
<div class="tab active" onclick="switchTab(0)">üìÖ All Classes</div>
<div class="tab" onclick="switchTab(1)">‚úÖ My Schedule</div>
</div>

<div id="allClasses" class="tab-content active">
<p style="text-align:center;color:#666;font-size:13px;margin:10px 0">
Click classes to select ‚Ä¢ Max 2 per time block ‚Ä¢ üîó = Multi-block class ‚Ä¢ Click class name to see description
</p>
<table class="schedule-table" id="scheduleTable">
<thead>
<tr>
<th style="width:120px">Time</th>
<th>Monday</th>
<th>Tuesday</th>
<th>Wednesday</th>
<th>Thursday</th>
<th>Friday</th>
</tr>
</thead>
<tbody id="scheduleBody"></tbody>
</table>
</div>

<div id="mySchedule" class="tab-content">
<h2 style="text-align:center;color:#2196F3;margin-bottom:20px" id="scheduleTitle"></h2>
<table class="my-schedule-table" id="myScheduleTable">
<thead>
<tr>
<th style="width:120px">Time</th>
<th>Monday</th>
<th>Tuesday</th>
<th>Wednesday</th>
<th>Thursday</th>
<th>Friday</th>
</tr>
</thead>
<tbody id="myScheduleBody"></tbody>
</table>
</div>

</div>

<script>
const API='https://script.google.com/macros/s/AKfycbwUV7DXx8J4p31M5jT5NjulaSdmWMpxdDWDogUEv4bFB2Gc5NcDGKSco9ytsmdxhNzu/exec';
const TIMES=[
{name:'Block 1',time:'10:00-10:45',display:'10:00-10:45 am'},
{name:'Block 2',time:'10:50-11:35',display:'10:50-11:35 am'},
{name:'üçΩÔ∏è LUNCH',time:'11:35-12:05',display:'11:35 am-12:05 pm'},
{name:'Block 3',time:'12:10-12:55',display:'12:10-12:55 pm'},
{name:'Block 4',time:'1:00-1:50',display:'1:00-1:50 pm'},
{name:'Block 5',time:'1:55-2:45',display:'1:55-2:45 pm'}
];
const DAYS=['monday','tuesday','wednesday','thursday','friday'];

let offerings=[],selected={},enrollmentCounts={},descriptions={},studentNames=[];

async function init(){
try{
showStatus('Loading...','success');

// Fetch data with timeout and retry
const fetchWithTimeout = (url, timeout = 10000) => {
  return Promise.race([
    fetch(url),
    new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Request timeout')), timeout)
    )
  ]);
};

const [off, enroll, students] = await Promise.all([
  fetchWithTimeout(`${API}?action=loadOfferings`).then(r=>r.json()).catch(e=>{
    console.error('Error loading offerings:', e);
    return {offerings: []};
  }),
  fetchWithTimeout(`${API}?action=getEnrollmentCounts`).then(r=>r.json()).catch(e=>{
    console.error('Error loading enrollment:', e);
    return {counts: {}};
  }),
  fetchWithTimeout(`${API}?action=getAllStudents`).then(r=>r.json()).catch(e=>{
    console.error('Error loading students:', e);
    return {success: false, students: []};
  })
]);

console.log('Offerings loaded:', off.offerings?.length || 0);
console.log('Enrollment data loaded:', Object.keys(enroll.counts || {}).length);
console.log('Students response:', students);

// Handle getAllStudents response (with student objects)
if (students && students.success && Array.isArray(students.students)) {
  // Students sheet exists - use it (includes ID, name, grade, level)
  studentNames = students.students;
  console.log('Student names from Students sheet:', studentNames);
} else {
  // Fallback to approved students if Students sheet doesn't exist
  const fallback = await fetchWithTimeout(`${API}?action=loadStudents`).then(r=>r.json()).catch(e=>({students: []}));
  if (fallback.students && Array.isArray(fallback.students)) {
    studentNames = fallback.students.map(name => typeof name === 'string' ? {id: '', name: name} : name);
  } else {
    studentNames = [];
  }
  console.log('Student names from fallback:', studentNames);
}

offerings=off.offerings||[];
enrollmentCounts=enroll.counts||{};

console.log('Final studentNames array:', studentNames);
console.log('Number of students:', studentNames.length);

loadDescriptions();
populateStudentDropdown();
drawSchedule();
checkURLParams();

document.getElementById('status').style.display='none';
}catch(e){
console.error('Init error:', e);
showStatus('Error loading: '+e.message,'error');
}
}

function populateStudentDropdown(){
const select=document.getElementById('studentName');
// Keep the first "Select Student Name" option
select.innerHTML='<option value="">-- Select Student Name --</option>';

console.log('Populating dropdown with', studentNames.length, 'students');

if(studentNames.length === 0){
console.warn('No students found!');
const option=document.createElement('option');
option.value='';
option.textContent='(No students yet)';
option.disabled=true;
select.appendChild(option);
return;
}

// Sort students by name
const sortedStudents = [...studentNames].sort((a,b)=>{
const nameA = typeof a === 'string' ? a : (a.name || '');
const nameB = typeof b === 'string' ? b : (b.name || '');
return nameA.localeCompare(nameB);
});

sortedStudents.forEach(student=>{
const option=document.createElement('option');
// Handle both string names and student objects
if (typeof student === 'string') {
option.value = student;
option.textContent = student;
} else {
const name = student.name || '';
const id = student.id || '';
const grade = student.grade || '';
const level = student.level || '';
option.value = name;
let displayText = name;
if (id) displayText += ` (ID: ${id})`;
if (grade) displayText += ` - Grade ${grade}`;
if (level) displayText += ` - ${level}`;
option.textContent = displayText;
}
select.appendChild(option);
console.log('Added student:', option.textContent);
});

console.log('Dropdown populated with', select.options.length - 1, 'students');
}

function loadDescriptions(){
descriptions={
'Math(A) (Canopy+)':'Early middle school math topics with focus on geometry and algebra foundations.',
'Chemistry (Canopy+)':'Foundations of Chemistry including elements, Periodic Table, matter, molecules, and reactions.',
'Intermediate Writing (Canopy+)':'Intermediate level writing with assignments between sessions.',
'Chemistry Lab (Canopy+)':'Hands-on laboratory experiments reinforcing chemistry concepts.',
'Coding (Saplings+)':'Game design and coding projects using Scratch platform.',
'D&D (Acorns)':'Dungeons & Dragons role-playing adventure game.',
'History Lab (Saplings+)':'Interactive deep dive into various historical eras and events.',
'Newspaper (Saplings+)':'Create and publish school newspaper content and articles.',
'Art Fundamentals (Acorns)':'Master pencil control, inking techniques, shading, and perspective drawing.',
'Songwriting (Saplings+)':'Learn songwriting techniques and create original songs.',
'All things Lego':'Free play in Lego room, brick films, and robotics exploration.',
'Theatre':'Theatre performance class with staging and acting techniques.',
'Debate Club (Canopy+)':'Learn debate skills and practice structured debates on various topics.'
};
}

function drawSchedule(){
const tbody=document.getElementById('scheduleBody');
tbody.innerHTML='';

TIMES.forEach(block=>{
const row=document.createElement('tr');
const timeCell=document.createElement('td');
timeCell.className='time-col';
timeCell.innerHTML=`<div style="font-size:13px">${block.name}</div><div style="font-size:11px;color:#666">${block.display}</div>`;
row.appendChild(timeCell);

DAYS.forEach(day=>{
const cell=document.createElement('td');
cell.id=`${day}-${block.time}`;

// Filter offerings - handle both single and comma-separated days/times
const dayOfferings=offerings.filter(o=>{
// Split days and times if comma-separated
const offeringDays = o.day ? o.day.split(',').map(d=>d.trim().toLowerCase()) : [];
const offeringTimes = o.time ? o.time.split(',').map(t=>t.trim()) : [];

// Check if this offering matches current day and time
return offeringDays.includes(day) && offeringTimes.includes(block.time);
});

dayOfferings.forEach(o=>{
const enrolled=enrollmentCounts[o.id]||0;
const capacity=Number(o.capacity)||999;
const full=enrolled>=capacity;
const isMultiBlock=isPartOfMultiBlock(o);

const card=document.createElement('div');
card.className='class-card'+(full?' full':'');
card.dataset.id=o.id;
card.dataset.day=day;
card.dataset.time=block.time;
card.dataset.group=isMultiBlock?getGroupKey(o):'';

const desc=descriptions[o.name]||o.description||'';
card.innerHTML=`
<label style="display:flex;align-items:start;cursor:pointer">
<input type="checkbox" ${full?'disabled':''} onclick="event.stopPropagation();toggleClass(this)">
<div style="flex:1">
<div class="class-name">
<span onclick="event.stopPropagation();toggleDesc(this)" style="cursor:pointer;text-decoration:${desc?'underline dotted':''}">${o.name}</span>
${isMultiBlock?'<span class="link-icon" title="Multi-block class">üîó</span>':''}
<span class="type-badge type-${o.type}">${o.type}</span>
${desc?'<span class="expand-icon">‚ñº</span>':''}
</div>
<div class="class-info">üë§ ${o.instructor} | üìç ${o.location||'TBA'} | üë• ${enrolled}/${capacity}</div>
${desc?`<div class="class-desc">${desc}</div>`:''}
</div>
</label>
`;

card.onclick=function(e){
if(e.target.tagName==='INPUT'||e.target.closest('.class-name span'))return;
if(!full){
const cb=this.querySelector('input');
cb.checked=!cb.checked;
toggleClass(cb);
}
};

cell.appendChild(card);
});

row.appendChild(cell);
});

tbody.appendChild(row);
});

updateUI();
}

function isPartOfMultiBlock(offering){
return offerings.filter(o=>
o.name===offering.name&&
o.day===offering.day&&
o.instructor===offering.instructor
).length>1;
}

function getGroupKey(offering){
return `${offering.name}_${offering.day}_${offering.instructor}`.replace(/[^a-zA-Z0-9]/g,'_');
}

function toggleClass(checkbox){
const card=checkbox.closest('.class-card');
const id=Number(card.dataset.id);
const day=card.dataset.day;
const time=card.dataset.time;
const group=card.dataset.group;
const key=`${day}-${time}`;

if(checkbox.checked){
if(group){
const groupOfferings=offerings.filter(o=>getGroupKey(o)===group&&o.day===day);
let canSelectAll=true;

groupOfferings.forEach(o=>{
const k=`${o.day}-${o.time}`;
if(!selected[k])selected[k]=[];
const currentCount=selected[k].filter(i=>i!==id).length;
if(currentCount>=2){canSelectAll=false}
});

if(!canSelectAll){
checkbox.checked=false;
showStatus('‚ö†Ô∏è Cannot select - some blocks are full (max 2 per block)','error');
return;
}

groupOfferings.forEach(o=>{
const k=`${o.day}-${o.time}`;
if(!selected[k])selected[k]=[];
if(!selected[k].includes(o.id))selected[k].push(o.id);
});

showStatus(`‚úÖ Selected all ${groupOfferings.length} blocks of this class`,'success');
}else{
if(!selected[key])selected[key]=[];
if(!selected[key].includes(id)){
if(selected[key].length>=2){
checkbox.checked=false;
showStatus('‚ö†Ô∏è Max 2 classes per time block','error');
return;
}
selected[key].push(id);
}
}
}else{
if(group){
const groupOfferings=offerings.filter(o=>getGroupKey(o)===group&&o.day===day);
groupOfferings.forEach(o=>{
const k=`${o.day}-${o.time}`;
if(selected[k])selected[k]=selected[k].filter(i=>i!==o.id);
});
}else{
if(selected[key])selected[key]=selected[key].filter(i=>i!==id);
}
}

updateUI();
}

function toggleDesc(element){
const card=element.closest('.class-card');
card.classList.toggle('expanded');
const icon=card.querySelector('.expand-icon');
if(icon)icon.textContent=card.classList.contains('expanded')?'‚ñ≤':'‚ñº';
}

function updateUI(){
document.querySelectorAll('.class-card').forEach(card=>{
const id=Number(card.dataset.id);
const day=card.dataset.day;
const time=card.dataset.time;
const key=`${day}-${time}`;
const isSelected=selected[key]?.includes(id);

card.classList.toggle('selected',isSelected);
const cb=card.querySelector('input');
if(cb)cb.checked=isSelected;
});

renderMySchedule();
}

function renderMySchedule(){
const tbody=document.getElementById('myScheduleBody');
tbody.innerHTML='';

const name=document.getElementById('studentName').value;
document.getElementById('scheduleTitle').textContent=name?`${name}'s Schedule`:'My Schedule';

TIMES.forEach(block=>{
const row=document.createElement('tr');
const timeCell=document.createElement('td');
timeCell.className='time-col';
timeCell.innerHTML=`<div style="font-size:13px">${block.name}</div><div style="font-size:11px;color:#666">${block.display}</div>`;
row.appendChild(timeCell);

DAYS.forEach(day=>{
const cell=document.createElement('td');
const key=`${day}-${block.time}`;
const ids=selected[key]||[];

if(ids.length===0){
cell.innerHTML='<div style="color:#ccc;text-align:center;padding:20px">-</div>';
}else{
ids.forEach(id=>{
const o=offerings.find(of=>of.id===id);
if(o){
const desc=descriptions[o.name]||o.description||'';

const div=document.createElement('div');
div.className='my-schedule-card';
div.style.cursor=desc?'pointer':'default';
div.style.minHeight='60px';
div.innerHTML=`
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
<strong style="font-size:13px;white-space:nowrap">${o.name}</strong>
${desc?'<span style="font-size:10px;color:#999">‚ñº</span>':''}
<span style="font-size:11px;color:#666">|</span>
<span style="font-size:11px;color:#666">üë§ ${o.instructor}</span>
<span style="font-size:11px;color:#666">|</span>
<span style="font-size:11px;color:#666">üìç ${o.location||'TBA'}</span>
${o.level?`<span style="font-size:11px;color:#666">|</span><span style="font-size:11px;color:#666">üìä ${o.level.charAt(0).toUpperCase()+o.level.slice(1)}</span>`:''}
</div>
${desc?`<div class="class-desc" style="display:none;font-size:11px;color:#555;margin-top:8px;padding-top:8px;border-top:1px solid #ddd;line-height:1.4">${desc}</div>`:''}
`;

if(desc){
div.onclick=function(){
const descDiv=this.querySelector('.class-desc');
const arrow=this.querySelector('span[style*="font-size:10px"]');
if(descDiv.style.display==='none'){
descDiv.style.display='block';
arrow.textContent='‚ñ≤';
}else{
descDiv.style.display='none';
arrow.textContent='‚ñº';
}
};
}

cell.appendChild(div);
}
});
}

row.appendChild(cell);
});

tbody.appendChild(row);
});
}

async function loadSchedule(){
const name=document.getElementById('studentName').value;
if(!name){showStatus('‚ö†Ô∏è Please select a student','error');return}

try{
const data=await fetch(`${API}?action=loadStudent&studentName=${encodeURIComponent(name)}`).then(r=>r.json());

selected={};

if(data.success&&data.offerings){
data.offerings.forEach(o=>{
const key=`${o.day}-${o.time}`;
if(!selected[key])selected[key]=[];
selected[key].push(o.id);
});
showStatus('‚úÖ Schedule loaded successfully','success');
}else{
showStatus('‚ÑπÔ∏è No saved schedule found','error');
}

updateUI();
}catch(e){showStatus('‚ùå Error loading: '+e.message,'error')}
}

async function saveSchedule(){
const name=document.getElementById('studentName').value;
if(!name){showStatus('‚ö†Ô∏è Please select a student','error');return}

const allIds=Object.values(selected).flat();
if(allIds.length===0){showStatus('‚ö†Ô∏è Please select some classes first','error');return}

try{
const response = await fetch(API,{
method:'POST',
body:JSON.stringify({
action:'saveStudentSchedule',
studentName:name,
offeringIds:allIds
})
});
const result = await response.json();

if(result.success){
showStatus(`‚è≥ Schedule request submitted! (${allIds.length} classes) - Awaiting admin approval.`,'success');
}else{
showStatus('‚ùå Error: '+result.message,'error');
}
}catch(e){showStatus('‚ùå Error saving: '+e.message,'error')}
}

function switchTab(i){
document.querySelectorAll('.tab').forEach((t,idx)=>{
t.classList.toggle('active',idx===i);
});
document.querySelectorAll('.tab-content').forEach((t,idx)=>{
t.classList.toggle('active',idx===i);
});
}

function showStatus(msg,type){
const el=document.getElementById('status');
el.textContent=msg;
el.className='status-'+type;
el.style.display='block';
setTimeout(()=>el.style.display='none',3000);
}

function checkURLParams(){
const params=new URLSearchParams(window.location.search);
const student=params.get('student');
if(student){
document.getElementById('studentName').value=student;
loadSchedule();
}
}

window.onload=init;
</script>
</body>
</html>

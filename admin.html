<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canopy Admin</title>
<style>
*{box-sizing:border-box}body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}
.container{max-width:1600px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h1{text-align:center;color:#2196F3;margin-bottom:5px}h2{font-size:16px;color:#666;text-align:center;margin:0 0 20px}
.tabs{display:flex;border-bottom:2px solid #ddd;margin-bottom:20px;gap:5px}
.tab{padding:12px 24px;cursor:pointer;background:#f0f0f0;border:none;border-bottom:3px solid transparent;font-size:16px;border-radius:8px 8px 0 0}
.tab:hover{background:#e0e0e0}.tab.active{background:white;border-bottom:3px solid #2196F3;color:#2196F3;font-weight:bold}
.tab-content{display:none}.tab-content.active{display:block}
.status{padding:12px;margin-bottom:20px;border-radius:4px;text-align:center;display:none}
.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:8px;text-align:center}
.stat-card h3{margin:0;font-size:32px}.stat-card p{margin:5px 0 0;font-size:13px;opacity:0.9}
.actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px}
.search{display:flex;gap:10px;flex:1;max-width:600px}
.search input,.search select{padding:8px;border:2px solid #ddd;border-radius:4px;font-size:14px}
.search input{flex:1;min-width:200px}
.btn{padding:10px 20px;font-size:14px;cursor:pointer;border:none;border-radius:4px;font-weight:600}
.btn-primary{background:#4CAF50;color:white}.btn-primary:hover{background:#45a049}
.btn-secondary{background:#2196F3;color:white}.btn-secondary:hover{background:#0b7dda}
.btn-danger{background:#f44336;color:white}.btn-danger:hover{background:#da190b}
.btn-small{padding:6px 12px;font-size:12px}
table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
th{background:#4CAF50;color:white;padding:12px 8px;text-align:left;font-weight:bold;position:sticky;top:0}
td{padding:10px 8px;border:1px solid #ddd;vertical-align:top}
tr:nth-child(even){background:#f9f9f9}tr:hover{background:#e3f2fd}
.badge{display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;text-transform:uppercase}
.badge-commitment{background:#ffcdd2;color:#c62828}.badge-drop-in{background:#c8e6c9;color:#2e7d32}.badge-private{background:#ffe0b2;color:#e65100}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.5)}
.modal-content{background:white;margin:2% auto;padding:0;border-radius:8px;width:90%;max-width:800px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;background:#4CAF50;color:white;border-radius:8px 8px 0 0}.modal-header h2{margin:0;color:white;text-align:left}
.modal-body{padding:20px}.modal-footer{padding:15px 20px;background:#f8f9fa;border-radius:0 0 8px 8px;display:flex;justify-content:flex-end;gap:10px}
.close{color:white;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close:hover{opacity:0.8}
.form-group{margin-bottom:15px}.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:4px;font-size:14px}
.form-group textarea{min-height:80px;resize:vertical}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.loading{text-align:center;padding:40px;color:#999}.spinner{border:4px solid #f3f3f3;border-top:4px solid #4CAF50;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:#999;font-size:48px}
.detail{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px}.detail h3{margin:0 0 10px;color:#2196F3}
.class-item{background:white;padding:8px 12px;margin:5px 0;border-radius:4px;border-left:3px solid #2196F3;font-size:13px}
@media (max-width:768px){.form-row{grid-template-columns:1fr}.actions{flex-direction:column}.search{max-width:100%;flex-direction:column}.stats{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="container">
<h1>üéì Canopy Admin</h1>
<h2>Session 3 (2025-2026)</h2>
<div id="status" class="status"></div>
<div class="tabs">
<button class="tab active" onclick="switchTab(0)">üë• Students</button>
<button class="tab" onclick="switchTab(1)">üìö Offerings</button>
</div>
<div id="students" class="tab-content active">
<div class="stats">
<div class="stat-card"><h3 id="totalStudents">0</h3><p>Students</p></div>
<div class="stat-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)"><h3 id="totalEnrollments">0</h3><p>Enrollments</p></div>
<div class="stat-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)"><h3 id="avgClasses">0</h3><p>Avg/Student</p></div>
</div>
<div class="actions">
<div class="search"><input type="text" id="searchStudents" placeholder="Search..." oninput="renderStudents()"></div>
<button class="btn btn-secondary" onclick="loadStudents()">üîÑ</button>
</div>
<div id="studentsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div id="offerings" class="tab-content">
<div class="stats">
<div class="stat-card"><h3 id="totalOfferings">0</h3><p>Offerings</p></div>
<div class="stat-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)"><h3 id="totalInstructors">0</h3><p>Instructors</p></div>
<div class="stat-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)"><h3 id="commitmentCount">0</h3><p>Commitment</p></div>
<div class="stat-card" style="background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%)"><h3 id="dropInCount">0</h3><p>Drop-in</p></div>
</div>
<div class="actions">
<div class="search">
<input type="text" id="searchOfferings" placeholder="Search..." oninput="renderOfferings()">
<select id="filterDay" onchange="renderOfferings()"><option value="">All Days</option><option value="monday">Mon</option><option value="tuesday">Tue</option><option value="wednesday">Wed</option><option value="thursday">Thu</option><option value="friday">Fri</option></select>
<select id="filterType" onchange="renderOfferings()"><option value="">All Types</option><option value="commitment">Commitment</option><option value="drop-in">Drop-in</option><option value="private">Private</option></select>
</div>
<button class="btn btn-secondary" onclick="loadOfferings()">üîÑ</button>
<button class="btn btn-primary" onclick="showAddModal()">+ Add</button>
</div>
<div id="offeringsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>
</div>
<div id="offeringModal" class="modal">
<div class="modal-content">
<div class="modal-header"><span class="close" onclick="closeModal()">&times;</span><h2 id="modalTitle">Add Offering</h2></div>
<div class="modal-body">
<form id="form">
<div class="form-group"><label>Name *</label><input type="text" id="name" required></div>
<div class="form-row">
<div class="form-group"><label>Facilitators *</label><select id="instructor" multiple size="6" required><option value="Amber">Amber</option><option value="Anna">Anna</option><option value="Ashlyn">Ashlyn</option><option value="Doug">Doug</option><option value="Elliott">Elliott</option><option value="Geoff">Geoff</option><option value="Grace">Grace</option><option value="Jamie">Jamie</option><option value="Jenique">Jenique</option><option value="Lacy">Lacy</option><option value="Nancy">Nancy</option><option value="Penny">Penny</option><option value="Tiff">Tiff</option><option value="Travis">Travis</option></select></div>
<div class="form-group"><label>Location</label><input type="text" id="location"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Days *</label><div style="padding:10px;border:2px solid #ddd;border-radius:4px">
<label style="font-weight:normal"><input type="checkbox" name="days" value="monday"> Mon</label><br>
<label style="font-weight:normal"><input type="checkbox" name="days" value="tuesday"> Tue</label><br>
<label style="font-weight:normal"><input type="checkbox" name="days" value="wednesday"> Wed</label><br>
<label style="font-weight:normal"><input type="checkbox" name="days" value="thursday"> Thu</label><br>
<label style="font-weight:normal"><input type="checkbox" name="days" value="friday"> Fri</label>
</div></div>
<div class="form-group"><label>Times *</label><div style="padding:10px;border:2px solid #ddd;border-radius:4px;max-height:200px;overflow-y:auto">
<label style="font-weight:normal"><input type="checkbox" name="times" value="10:00-10:45"> Block 1</label><br>
<label style="font-weight:normal"><input type="checkbox" name="times" value="10:50-11:35"> Block 2</label><br>
<label style="font-weight:normal"><input type="checkbox" name="times" value="11:35-12:05"> Lunch</label><br>
<label style="font-weight:normal"><input type="checkbox" name="times" value="12:10-12:55"> Block 3</label><br>
<label style="font-weight:normal"><input type="checkbox" name="times" value="1:00-1:50"> Block 4</label><br>
<label style="font-weight:normal"><input type="checkbox" name="times" value="1:55-2:45"> Block 5</label>
</div></div>
</div>
<div class="form-row">
<div class="form-group"><label>Type *</label><select id="type" required><option value="">Select</option><option value="commitment">Commitment</option><option value="drop-in">Drop-in</option><option value="private">Private</option></select></div>
<div class="form-group"><label>Levels</label><select id="level" multiple size="5"><option value="All">All Ages</option><option value="EC">EC</option><option value="Saplings">Saplings</option><option value="Acorns">Acorns</option><option value="Canopy">Canopy</option></select></div>
</div>
<div class="form-group"><label>Capacity</label><input type="number" id="capacity" min="1" placeholder="999 = unlimited"></div>
<div class="form-group"><label>Description</label><textarea id="description"></textarea></div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
<button class="btn btn-primary" onclick="save()">Save</button>
</div>
</div>
</div>
<div id="detailModal" class="modal">
<div class="modal-content">
<div class="modal-header"><span class="close" onclick="closeDetail()">&times;</span><h2 id="detailTitle"></h2></div>
<div class="modal-body" id="detailBody"></div>
<div class="modal-footer" id="detailFooter"></div>
</div>
</div>

<script>
const API='https://script.google.com/macros/s/AKfycbwUV7DXx8J4p31M5jT5NjulaSdmWMpxdDWDogUEv4bFB2Gc5NcDGKSco9ytsmdxhNzu/exec';
let students=[],offerings=[],currentEdit=null;

function switchTab(i){
document.querySelectorAll('.tab-content,.tab').forEach(e=>e.classList.remove('active'));
document.querySelectorAll('.tab')[i].classList.add('active');
document.querySelectorAll('.tab-content')[i].classList.add('active');
if(i===0&&!students.length)loadStudents();
if(i===1&&!offerings.length)loadOfferings();
}

async function loadStudents(){
try{
document.getElementById('studentsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadAll`);
const d=await r.json();
students=d.students||[];
document.getElementById('totalStudents').textContent=students.length;
const total=students.reduce((s,st)=>s+(st.totalClasses||0),0);
document.getElementById('totalEnrollments').textContent=total;
document.getElementById('avgClasses').textContent=students.length?Math.round(total/students.length):0;
renderStudents();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderStudents(){
const c=document.getElementById('studentsContainer');
const search=document.getElementById('searchStudents').value.toLowerCase();
const filtered=students.filter(s=>s.name.toLowerCase().includes(search));
if(!filtered.length){c.innerHTML='<div class="empty">üë•<br>No students</div>';return}
let html='<table><thead><tr><th>Name</th><th style="width:100px">Classes</th><th style="width:180px">Updated</th><th style="width:120px">Actions</th></tr></thead><tbody>';
filtered.forEach(s=>{
const date=s.timestamp?new Date(s.timestamp).toLocaleDateString():'N/A';
html+=`<tr><td><strong>${s.name}</strong></td><td>${s.totalClasses||0}</td><td>${date}</td>
<td><button class="btn btn-secondary btn-small" onclick="viewStudent('${s.name}')">View</button></td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

function viewStudent(name){
const s=students.find(st=>st.name===name);
if(!s)return;
let classes=[];
try{classes=JSON.parse(s.classes||'[]')}catch(e){}
let html=`<div class="detail"><p><strong>Name:</strong> ${name}</p><p><strong>Classes:</strong> ${s.totalClasses||0}</p>
<p><strong>Updated:</strong> ${s.timestamp?new Date(s.timestamp).toLocaleString():'N/A'}</p></div><h3>Classes:</h3>`;
if(!classes.length){html+='<p style="color:#999;text-align:center">No classes</p>'}
else{classes.forEach(c=>{
const day=c.day?c.day.charAt(0).toUpperCase()+c.day.slice(1):'';
html+=`<div class="class-item"><strong>${c.name||c.offeringName||'Unknown'}</strong><br>
<span style="font-size:12px;color:#666">üë§ ${c.instructor||''} | üìÖ ${day} | ‚è∞ ${c.time||''}</span></div>`;
})}
document.getElementById('detailTitle').textContent=name+"'s Schedule";
document.getElementById('detailBody').innerHTML=html;
document.getElementById('detailFooter').innerHTML='<button class="btn btn-primary" onclick="closeDetail()">Close</button>';
document.getElementById('detailModal').style.display='block';
}

async function loadOfferings(){
try{
if(!students.length)await loadStudents();
document.getElementById('offeringsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadOfferings`);
const d=await r.json();
offerings=d.offerings||[];
document.getElementById('totalOfferings').textContent=offerings.length;
const instructors=new Set(offerings.map(o=>o.instructor));
document.getElementById('totalInstructors').textContent=instructors.size;
document.getElementById('commitmentCount').textContent=offerings.filter(o=>o.type==='commitment').length;
document.getElementById('dropInCount').textContent=offerings.filter(o=>o.type==='drop-in').length;
renderOfferings();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderOfferings(){
const c=document.getElementById('offeringsContainer');
const search=document.getElementById('searchOfferings').value.toLowerCase();
const day=document.getElementById('filterDay').value;
const type=document.getElementById('filterType').value;
let filtered=offerings.filter(o=>{
const matchSearch=!search||o.name.toLowerCase().includes(search)||o.instructor.toLowerCase().includes(search);
const matchDay=!day||o.day===day;
const matchType=!type||o.type===type;
return matchSearch&&matchDay&&matchType;
});
if(!filtered.length){c.innerHTML='<div class="empty">üìö<br>No offerings</div>';return}
let html='<table><thead><tr><th>Name</th><th style="width:120px">Instructor</th><th style="width:80px">Day</th><th style="width:100px">Time</th><th style="width:80px">Type</th><th style="width:80px">Enrolled</th><th style="width:150px">Actions</th></tr></thead><tbody>';
filtered.forEach(o=>{
const enrolled=getEnrolled(o);
const day=o.day.charAt(0).toUpperCase()+o.day.slice(1);
html+=`<tr><td><strong>${o.name}</strong></td><td>${o.instructor}</td><td>${day}</td><td style="font-size:11px">${o.time}</td>
<td><span class="badge badge-${o.type}">${o.type}</span></td>
<td><button class="btn btn-secondary btn-small" onclick="viewEnroll(${o.id})" style="background:${enrolled.length?'#4CAF50':'#999'}">
${enrolled.length} üë•</button></td>
<td><button class="btn btn-secondary btn-small" onclick="editOffering(${o.id})">Edit</button>
<button class="btn btn-danger btn-small" onclick="deleteOffering(${o.id})">Del</button></td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

function getEnrolled(o){
const enrolled=[];
students.forEach(s=>{
try{
const classes=JSON.parse(s.classes||'[]');
const found=classes.some(c=>(c.name||c.offeringName)===o.name&&c.day===o.day&&c.time===o.time);
if(found)enrolled.push(s.name);
}catch(e){}
});
return enrolled;
}

function viewEnroll(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
const enrolled=getEnrolled(o);
const day=o.day.charAt(0).toUpperCase()+o.day.slice(1);
let html=`<div class="detail"><p><strong>Class:</strong> ${o.name}</p><p><strong>Instructor:</strong> ${o.instructor}</p>
<p><strong>When:</strong> ${day}, ${o.time}</p><p><strong>Type:</strong> <span class="badge badge-${o.type}">${o.type}</span></p>
<p><strong>Enrolled:</strong> ${enrolled.length}</p></div><h3>Students:</h3>`;
if(!enrolled.length){html+='<p style="color:#999;text-align:center">No students</p>'}
else{enrolled.sort().forEach(name=>{html+=`<div class="class-item"><strong>${name}</strong></div>`})}
document.getElementById('detailTitle').textContent='Enrollment: '+o.name;
document.getElementById('detailBody').innerHTML=html;
document.getElementById('detailFooter').innerHTML='<button class="btn btn-primary" onclick="closeDetail()">Close</button>';
document.getElementById('detailModal').style.display='block';
}

function showAddModal(){
currentEdit=null;
document.getElementById('modalTitle').textContent='Add Offering';
document.getElementById('form').reset();
document.querySelectorAll('input[name="days"],input[name="times"]').forEach(cb=>cb.checked=false);
document.getElementById('offeringModal').style.display='block';
}

function editOffering(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
currentEdit=o;
document.getElementById('modalTitle').textContent='Edit Offering';
document.getElementById('name').value=o.name;
const instructors=o.instructor.split(' & ');
Array.from(document.getElementById('instructor').options).forEach(opt=>opt.selected=instructors.includes(opt.value));
document.getElementById('location').value=o.location||'';
document.getElementById('type').value=o.type;
document.getElementById('capacity').value=o.capacity||'';
document.getElementById('description').value=o.description||'';
const related=offerings.filter(of=>of.name===o.name&&of.instructor===o.instructor);
const days=[...new Set(related.map(r=>r.day))];
const times=[...new Set(related.map(r=>r.time))];
document.querySelectorAll('input[name="days"]').forEach(cb=>cb.checked=days.includes(cb.value));
document.querySelectorAll('input[name="times"]').forEach(cb=>cb.checked=times.includes(cb.value));
if(o.level){
const levels=o.level.split(', ');
Array.from(document.getElementById('level').options).forEach(opt=>opt.selected=levels.includes(opt.value));
}
document.getElementById('offeringModal').style.display='block';
}

async function save(){
const form=document.getElementById('form');
if(!form.checkValidity()){form.reportValidity();return}
const days=Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb=>cb.value);
if(!days.length){msg('‚ö†Ô∏è Select days','error');return}
const times=Array.from(document.querySelectorAll('input[name="times"]:checked')).map(cb=>cb.value);
if(!times.length){msg('‚ö†Ô∏è Select times','error');return}
const instructors=Array.from(document.getElementById('instructor').selectedOptions).map(opt=>opt.value);
if(!instructors.length){msg('‚ö†Ô∏è Select facilitators','error');return}
const levels=Array.from(document.getElementById('level').selectedOptions).map(opt=>opt.value);
const base={
name:document.getElementById('name').value,
instructor:instructors.join(' & '),
location:document.getElementById('location').value,
type:document.getElementById('type').value,
level:levels.join(', '),
capacity:document.getElementById('capacity').value||999,
description:document.getElementById('description').value
};
try{
if(currentEdit){
const related=offerings.filter(o=>o.name===currentEdit.name&&o.instructor===currentEdit.instructor);
for(const r of related){
await fetch(API,{method:'POST',body:JSON.stringify({action:'deleteOffering',offeringId:r.id})});
}
}
for(const day of days){
for(const time of times){
const data={...base,day,time,action:'saveOffering'};
const r=await fetch(API,{method:'POST',body:JSON.stringify(data)});
const res=await r.json();
if(!res.success){msg('‚ùå '+res.message,'error');return}
}
}
msg('‚úÖ Saved','success');
closeModal();
await loadOfferings();
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function deleteOffering(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
const related=offerings.filter(of=>of.name===o.name&&of.instructor===o.instructor);
if(confirm(`Delete "${o.name}"? (${related.length} entries)`)){
try{
for(const r of related){
const res=await fetch(API,{method:'POST',body:JSON.stringify({action:'deleteOffering',offeringId:r.id})});
const result=await res.json();
if(!result.success){msg('‚ùå '+result.message,'error');return}
}
msg('‚úÖ Deleted','success');
await loadOfferings();
}catch(e){msg('‚ùå '+e.message,'error')}
}
}

function closeModal(){document.getElementById('offeringModal').style.display='none';currentEdit=null}
function closeDetail(){document.getElementById('detailModal').style.display='none'}
function msg(text,type){
const s=document.getElementById('status');
s.textContent=text;
s.className='status '+type;
s.style.display='block';
setTimeout(()=>s.style.display='none',3000);
}

window.onclick=e=>{if(e.target.classList.contains('modal'))e.target.style.display='none'}
window.onload=()=>loadStudents();
</script>
</body>
</html>

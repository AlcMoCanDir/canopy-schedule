<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canopy Admin - With Approvals</title>
<style>
*{box-sizing:border-box}body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}
.container{max-width:1600px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h1{text-align:center;color:#2196F3;margin-bottom:5px}h2{font-size:16px;color:#666;text-align:center;margin:0 0 20px}
.tabs{display:flex;border-bottom:2px solid #ddd;margin-bottom:20px;gap:5px}
.tab{padding:12px 20px;cursor:pointer;background:#f0f0f0;border:none;border-bottom:3px solid transparent;font-size:15px;border-radius:8px 8px 0 0}
.tab:hover{background:#e0e0e0}.tab.active{background:white;border-bottom:3px solid #2196F3;color:#2196F3;font-weight:bold}
.tab-content{display:none}.tab-content.active{display:block}
.status{padding:12px;margin-bottom:20px;border-radius:4px;text-align:center;display:none}
.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:8px;text-align:center}
.stat-card h3{margin:0;font-size:32px}.stat-card p{margin:5px 0 0;font-size:13px;opacity:0.9}
.stat-card.orange{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
.actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px}
.btn{padding:10px 20px;font-size:14px;cursor:pointer;border:none;border-radius:4px;font-weight:600}
.btn-primary{background:#4CAF50;color:white}.btn-primary:hover{background:#45a049}
.btn-secondary{background:#2196F3;color:white}.btn-secondary:hover{background:#0b7dda}
.btn-danger{background:#f44336;color:white}.btn-danger:hover{background:#da190b}
.btn-success{background:#4CAF50;color:white}.btn-success:hover{background:#45a049}
.btn-warning{background:#ff9800;color:white}.btn-warning:hover{background:#e68900}
.btn-small{padding:6px 12px;font-size:12px}
table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
th{background:#4CAF50;color:white;padding:12px 8px;text-align:left;font-weight:bold;position:sticky;top:0}
td{padding:10px 8px;border:1px solid #ddd;vertical-align:top}
tr:nth-child(even){background:#f9f9f9}tr:hover{background:#e3f2fd}
.badge{display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;text-transform:uppercase}
.badge-pending{background:#fff3cd;color:#856404;border:1px solid #ffc107}
.loading{text-align:center;padding:40px;color:#999}.spinner{border:4px solid #f3f3f3;border-top:4px solid #4CAF50;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:#999;font-size:48px}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.5)}
.modal-content{background:white;margin:2% auto;padding:0;border-radius:8px;width:90%;max-width:600px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;background:#4CAF50;color:white;border-radius:8px 8px 0 0}.modal-header h2{margin:0;color:white;text-align:left}
.modal-body{padding:20px}.modal-footer{padding:15px 20px;background:#f8f9fa;border-radius:0 0 8px 8px;display:flex;justify-content:flex-end;gap:10px}
.close{color:white;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close:hover{opacity:0.8}
.detail{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px}.detail h3{margin:0 0 10px;color:#2196F3}
.class-item{background:white;padding:8px 12px;margin:5px 0;border-radius:4px;border-left:3px solid #2196F3;font-size:13px}
@media (max-width:768px){.actions{flex-direction:column}.stats{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="container">
<h1>üéì Canopy Admin</h1>
<h2>Session 3 (2025-2026) - With Approval System</h2>
<div id="status" class="status"></div>
<div class="tabs">
<button class="tab active" onclick="switchTab(0)">‚è≥ Pending Requests</button>
<button class="tab" onclick="switchTab(1)">üë• Students</button>
<button class="tab" onclick="switchTab(2)">üìö Offerings</button>
</div>

<!-- PENDING REQUESTS TAB -->
<div id="pending" class="tab-content active">
<div class="stats">
<div class="stat-card orange"><h3 id="totalPending">0</h3><p>Pending Requests</p></div>
</div>
<div class="actions">
<button class="btn btn-secondary" onclick="loadPendingRequests()">üîÑ Refresh</button>
</div>
<div id="pendingContainer"><div class="loading"><div class="spinner"></div>Loading requests...</div></div>
</div>

<!-- STUDENTS TAB -->
<div id="students" class="tab-content">
<div class="stats">
<div class="stat-card"><h3 id="totalStudents">0</h3><p>Approved Students</p></div>
<div class="stat-card orange"><h3 id="totalEnrollments">0</h3><p>Total Enrollments</p></div>
</div>
<div class="actions">
<button class="btn btn-secondary" onclick="loadStudents()">üîÑ Refresh</button>
</div>
<div id="studentsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>

<!-- OFFERINGS TAB -->
<div id="offerings" class="tab-content">
<div class="stats">
<div class="stat-card"><h3 id="totalOfferings">0</h3><p>Offerings</p></div>
<div class="stat-card orange"><h3 id="totalInstructors">0</h3><p>Instructors</p></div>
</div>
<div class="actions">
<button class="btn btn-secondary" onclick="loadOfferings()">üîÑ Refresh</button>
</div>
<div id="offeringsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>
</div>

<!-- DETAIL MODAL -->
<div id="detailModal" class="modal">
<div class="modal-content">
<div class="modal-header"><span class="close" onclick="closeDetail()">&times;</span><h2 id="detailTitle"></h2></div>
<div class="modal-body" id="detailBody"></div>
<div class="modal-footer" id="detailFooter"></div>
</div>
</div>

<script>
const API='https://script.google.com/macros/s/AKfycbwUV7DXx8J4p31M5jT5NjulaSdmWMpxdDWDogUEv4bFB2Gc5NcDGKSco9ytsmdxhNzu/exec';
let pending=[],students=[],offerings=[];

function switchTab(i){
document.querySelectorAll('.tab-content,.tab').forEach(e=>e.classList.remove('active'));
document.querySelectorAll('.tab')[i].classList.add('active');
document.querySelectorAll('.tab-content')[i].classList.add('active');
if(i===0)loadPendingRequests();
if(i===1)loadStudents();
if(i===2)loadOfferings();
}

async function loadPendingRequests(){
try{
document.getElementById('pendingContainer').innerHTML='<div class="loading"><div class="spinner"></div>Loading...</div>';
const r=await fetch(`${API}?action=getPendingRequests`);
const d=await r.json();
pending=d.requests||[];
document.getElementById('totalPending').textContent=pending.length;
renderPendingRequests();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderPendingRequests(){
const c=document.getElementById('pendingContainer');
if(!pending.length){c.innerHTML='<div class="empty">‚úÖ<br>No pending requests</div>';return}
let html='<table><thead><tr><th>Student</th><th>Classes</th><th>Submitted</th><th style="width:200px">Actions</th></tr></thead><tbody>';
pending.forEach(p=>{
const date=new Date(p.submitted).toLocaleString();
html+=`<tr><td><strong>${p.studentName}</strong><br><span class="badge badge-pending">PENDING</span></td>
<td>${p.totalClasses} classes</td><td>${date}</td>
<td><button class="btn btn-success btn-small" onclick="viewRequest('${p.requestId}')">View</button>
<button class="btn btn-primary btn-small" onclick="approveRequest('${p.requestId}')">‚úì Approve</button>
<button class="btn btn-danger btn-small" onclick="denyRequest('${p.requestId}')">‚úó Deny</button></td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

async function viewRequest(id){
const p=pending.find(r=>r.requestId===id);
if(!p)return;
let classes=[];
try{classes=JSON.parse(p.offeringIds||'[]')}catch(e){}
const date=new Date(p.submitted).toLocaleString();
let html=`<div class="detail"><p><strong>Student:</strong> ${p.studentName}</p>
<p><strong>Submitted:</strong> ${date}</p><p><strong>Classes:</strong> ${p.totalClasses}</p>
<p><strong>Status:</strong> <span class="badge badge-pending">PENDING APPROVAL</span></p></div>
<h3>Requested Classes (IDs):</h3>`;
if(!classes.length){html+='<p style="color:#999">No classes</p>'}
else{html+='<p>'+classes.join(', ')+'</p>'}
document.getElementById('detailTitle').textContent='Request: '+p.studentName;
document.getElementById('detailBody').innerHTML=html;
document.getElementById('detailFooter').innerHTML=`
<button class="btn btn-secondary" onclick="closeDetail()">Close</button>
<button class="btn btn-primary" onclick="approveRequest('${id}');closeDetail()">‚úì Approve</button>
<button class="btn btn-danger" onclick="denyRequest('${id}');closeDetail()">‚úó Deny</button>`;
document.getElementById('detailModal').style.display='block';
}

async function approveRequest(id){
if(!confirm('Approve this schedule request?'))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'approveRequest',requestId:id})});
const d=await r.json();
if(d.success){
msg('‚úÖ Request approved!','success');
await loadPendingRequests();
await loadStudents();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function denyRequest(id){
if(!confirm('Deny this schedule request? Student will not be enrolled.'))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'denyRequest',requestId:id})});
const d=await r.json();
if(d.success){
msg('‚úÖ Request denied','success');
await loadPendingRequests();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function loadStudents(){
try{
document.getElementById('studentsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadAll`);
const d=await r.json();
students=d.students||[];
document.getElementById('totalStudents').textContent=students.length;
const total=students.reduce((s,st)=>s+(st.totalClasses||0),0);
document.getElementById('totalEnrollments').textContent=total;
renderStudents();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderStudents(){
const c=document.getElementById('studentsContainer');
if(!students.length){c.innerHTML='<div class="empty">üë•<br>No approved students yet</div>';return}
let html='<table><thead><tr><th>Name</th><th>Classes</th><th>Updated</th></tr></thead><tbody>';
students.forEach(s=>{
const date=s.timestamp?new Date(s.timestamp).toLocaleDateString():'N/A';
html+=`<tr><td><strong>${s.name}</strong></td><td>${s.totalClasses||0}</td><td>${date}</td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

async function loadOfferings(){
try{
document.getElementById('offeringsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadOfferings`);
const d=await r.json();
offerings=d.offerings||[];
document.getElementById('totalOfferings').textContent=offerings.length;
const instructors=new Set(offerings.map(o=>o.instructor));
document.getElementById('totalInstructors').textContent=instructors.size;
renderOfferings();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderOfferings(){
const c=document.getElementById('offeringsContainer');
if(!offerings.length){c.innerHTML='<div class="empty">üìö<br>No offerings</div>';return}
let html='<table><thead><tr><th>Name</th><th>Instructor</th><th>Day</th><th>Time</th><th>Type</th><th>Capacity</th></tr></thead><tbody>';
offerings.forEach(o=>{
const day=o.day.charAt(0).toUpperCase()+o.day.slice(1);
html+=`<tr><td><strong>${o.name}</strong></td><td>${o.instructor}</td><td>${day}</td><td style="font-size:11px">${o.time}</td>
<td>${o.type}</td><td>${o.capacity||999}</td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

function closeDetail(){document.getElementById('detailModal').style.display='none'}
function msg(text,type){
const s=document.getElementById('status');
s.textContent=text;
s.className='status '+type;
s.style.display='block';
setTimeout(()=>s.style.display='none',3000);
}

window.onclick=e=>{if(e.target.classList.contains('modal'))e.target.style.display='none'}
window.onload=()=>loadPendingRequests();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Facilitator Dashboard</title>
<style>
*{box-sizing:border-box}body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}
.container{max-width:1600px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h1{text-align:center;color:#2196F3;margin-bottom:5px}h2{font-size:16px;color:#666;text-align:center;margin:0 0 20px}
.tabs{display:flex;border-bottom:2px solid #ddd;margin-bottom:20px;gap:5px}
.tab{padding:12px 20px;cursor:pointer;background:#f0f0f0;border:none;border-bottom:3px solid transparent;font-size:15px;border-radius:8px 8px 0 0}
.tab:hover{background:#e0e0e0}.tab.active{background:white;border-bottom:3px solid #2196F3;color:#2196F3;font-weight:bold}
.tab-content{display:none}.tab-content.active{display:block}
.status{padding:12px;margin-bottom:20px;border-radius:4px;text-align:center;display:none}
.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
.stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:8px;text-align:center}
.stat-card h3{margin:0;font-size:32px}.stat-card p{margin:5px 0 0;font-size:13px;opacity:0.9}
.stat-card.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
.actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px}
.btn{padding:10px 20px;font-size:14px;cursor:pointer;border:none;border-radius:4px;font-weight:600;color:white}
.btn-primary,.btn-success{background:#4CAF50}.btn-primary:hover,.btn-success:hover{background:#45a049}
.btn-secondary{background:#2196F3}.btn-secondary:hover{background:#0b7dda}
.btn-danger{background:#f44336}.btn-danger:hover{background:#da190b}
.btn-warning{background:#ff9800}.btn-warning:hover{background:#e68900}
.btn-small{padding:6px 12px;font-size:12px;margin:2px}
.lbl{font-weight:bold;color:#333}
.inp{padding:8px;border:1px solid #ddd;border-radius:4px}
table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
th{background:#4CAF50;color:white;padding:12px 8px;text-align:left;font-weight:bold;position:sticky;top:0}
td{padding:10px 8px;border:1px solid #ddd;vertical-align:top}
tr:nth-child(even){background:#f9f9f9}tr:hover{background:#e3f2fd}
.badge{display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;text-transform:uppercase}
.badge-pending{background:#fff3cd;color:#856404;border:1px solid #ffc107}
.loading{text-align:center;padding:40px;color:#999}.spinner{border:4px solid #f3f3f3;border-top:4px solid #4CAF50;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:#999;font-size:48px}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.5)}
.modal-content{background:white;margin:2% auto;padding:0;border-radius:8px;width:90%;max-width:600px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;background:#4CAF50;color:white;border-radius:8px 8px 0 0}.modal-header h2{margin:0;color:white;text-align:left}
.modal-body{padding:20px}.modal-footer{padding:15px 20px;background:#f8f9fa;border-radius:0 0 8px 8px;display:flex;justify-content:flex-end;gap:10px}
.close{color:white;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close:hover{opacity:0.8}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#333}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px}
.form-group textarea{resize:vertical;min-height:80px}
.request-card{background:white;border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
.request-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid #eee}
.request-student{font-size:18px;font-weight:bold;color:#2196F3}
.class-row{background:#f8f9fa;padding:10px;margin:5px 0;border-radius:4px;display:flex;justify-content:space-between;align-items:center;border-left:3px solid #2196F3}
.class-info{flex:1}
.class-name{font-weight:bold;color:#333;font-size:14px}
.class-details{font-size:12px;color:#666;margin-top:3px}
.group-actions{margin-top:10px;padding-top:10px;border-top:1px solid #ddd;display:flex;gap:10px;justify-content:flex-end}
.attendance-roster{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;margin-top:20px}
.attendance-card{background:white;border:1px solid #ddd;border-radius:8px;padding:15px;box-shadow:0 2px 4px rgba(0,0,0,0.05);display:flex;align-items:center;gap:15px;transition:all 0.2s}
.attendance-card:hover{box-shadow:0 4px 8px rgba(0,0,0,0.1)}
.attendance-card.present{border-left:4px solid #4CAF50;background:#f1f8f4}
.attendance-card.absent{border-left:4px solid #ddd;background:#fafafa;opacity:0.7}
.attendance-checkbox{width:24px;height:24px;cursor:pointer}
.attendance-name{font-size:15px;font-weight:600;color:#333;flex:1}
.attendance-info{font-size:12px;color:#666;margin-top:3px}
.attendance-summary{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;display:flex;gap:30px;align-items:center}
.attendance-stat{text-align:center}
.attendance-stat-number{font-size:28px;font-weight:bold;color:#4CAF50}
.attendance-stat-label{font-size:12px;color:#666;margin-top:3px}
.editable-cell{cursor:pointer;padding:8px;border-radius:4px}
.editable-cell:hover{background:#e3f2fd}
.edit-icon{font-size:10px;color:#999;margin-left:5px}
@media (max-width:768px){.actions{flex-direction:column}.stats{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<h1>Facilitator Dashboard</h1>
<h2>Session 3: Jan-Feb 2026</h2>
<div id="status" class="status"></div>
<div class="tabs">
<button class="tab active" onclick="switchTab(0)">üë• Learners</button>
<button class="tab" onclick="switchTab(1)">‚úÖ Attendance</button>
<button class="tab" onclick="switchTab(2)">üìö Offerings</button>
<button class="tab" onclick="switchTab(3)">‚è≥ Pending Requests</button>
</div>


<!-- LEARNERS TAB -->
<div id="students" class="tab-content active">
<div class="actions">
<button class="btn btn-secondary" onclick="loadStudents()">üîÑ Refresh</button>
</div>
<div id="studentsContainer">
<div style="text-align:center;padding:60px 20px;color:#999">
<p style="font-size:18px">Click Refresh to load learners</p>
</div>
</div>
</div>


<!-- ATTENDANCE TAB -->
<div id="attendance" class="tab-content">
<div class="actions">
<label for="attendanceDate" class="lbl">Date:</label>
<input type="date" id="attendanceDate" onchange="loadAttendanceForDate()" class="inp">

<label for="attendanceOffering" class="lbl">Select Offering:</label>
<select id="attendanceOffering" onchange="loadAttendanceRoster()" style="padding:8px;border:1px solid #ddd;border-radius:4px;min-width:250px">
<option value="">-- Select Offering --</option>
</select>

<button class="btn btn-secondary" onclick="loadAttendanceTab()">üîÑ Refresh</button>
</div>
<div id="attendanceContainer">
<div style="text-align:center;padding:60px 20px;color:#999">
<p style="font-size:18px">Select a date and offering to mark attendance</p>
</div>
</div>
</div>

<!-- OFFERINGS TAB -->
<div id="offerings" class="tab-content">
<div class="stats">
<div class="stat-card"><h3 id="totalOfferings">-</h3><p>Offerings</p></div>
</div>
<div class="actions">
<button class="btn btn-primary" onclick="showCreateOfferingModal()">‚ûï Create New Offering</button>
<button class="btn btn-secondary" onclick="loadOfferings()">üîÑ Refresh</button>
</div>
<div class="actions" style="margin-top:10px">
<label for="sortBy" class="lbl">Sort By:</label>
<select id="sortBy" onchange="applyOfferingFilters()" class="inp">
<option value="default">Default (Day/Time)</option>
<option value="name">Class Name (A-Z)</option>
<option value="instructor">Instructor (A-Z)</option>
<option value="type">Type</option>
<option value="level">Level</option>
<option value="enrollment">Enrollment (High to Low)</option>
</select>

<label for="filterType" class="lbl">Filter Type:</label>
<select id="filterType" onchange="applyOfferingFilters()" class="inp">
<option value="">All Types</option>
<option value="commitment">Commitment</option>
<option value="drop-in">Drop-in</option>
<option value="private">Private</option>
</select>

<label for="filterLevel" class="lbl">Filter Level:</label>
<select id="filterLevel" onchange="applyOfferingFilters()" class="inp">
<option value="">All Levels</option>
<option value="acorns">Acorns</option>
<option value="canopy">Canopy</option>
<option value="canopy+">Canopy+</option>
<option value="saplings+">Saplings+</option>
<option value="playyard+">Playyard</option>
<option value="mixed">Mixed Age</option>
</select>

<label for="filterDay" class="lbl">Filter Day:</label>
<select id="filterDay" onchange="applyOfferingFilters()" class="inp">
<option value="">All Days</option>
<option value="monday">Monday</option>
<option value="tuesday">Tuesday</option>
<option value="wednesday">Wednesday</option>
<option value="thursday">Thursday</option>
<option value="friday">Friday</option>
</select>
</div>
<div id="offeringsContainer">
<div style="text-align:center;padding:60px 20px;color:#999">
<p style="font-size:18px">Click Refresh to load offerings</p>
</div>
</div>
</div>


<!-- PENDING REQUESTS TAB -->
<div id="pending" class="tab-content">
<div class="actions">
<button class="btn btn-secondary" onclick="loadPendingRequests()">üîÑ Refresh</button>
</div>
<div id="pendingContainer">
<div style="text-align:center;padding:60px 20px;color:#999">
<p style="font-size:18px">Click Refresh to load pending requests</p>
</div>
</div>
</div>


</div>

<!-- EDIT OFFERING MODAL -->
<div id="editModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeEditModal()">&times;</span>
<h2 id="editModalTitle">Edit Offering</h2>
</div>
<div class="modal-body">
<div class="form-group">
<label>Offering Name *</label>
<input type="text" id="editName" placeholder="Math(A)" required>
</div>
<div class="form-group">
<label>Instructor/Facilitator *</label>
<input type="text" id="editInstructor" placeholder="Anna" required>
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="editLocation" placeholder="Room 101">
</div>
<div class="form-group">
<label>Day *</label>
<select id="editDay" required>
<option value="monday">Monday</option>
<option value="tuesday">Tuesday</option>
<option value="wednesday">Wednesday</option>
<option value="thursday">Thursday</option>
<option value="friday">Friday</option>
</select>
</div>
<div class="form-group">
<label>Time *</label>
<input type="text" id="editTime" placeholder="10:00-10:45" required>
</div>
<div class="form-group">
<label>Type *</label>
<select id="editType" required>
<option value="commitment">Commitment</option>
<option value="drop-in">Drop-in</option>
<option value="private">Private</option>
</select>
</div>
<div class="form-group">
<label>Level</label>
<select id="editLevel">
<option value="">All Levels</option>
<option value="acorns">Acorns</option>
<option value="canopy">Canopy</option>
<option value="canopy+">Canopy+</option>
<option value="mixed">Mixed Age</option>
</select>
</div>
<div class="form-group">
<label>Description</label>
<textarea id="editDescription" placeholder="Describe what students will learn and do in this class..." rows="4"></textarea>
</div>
<div class="form-group">
<label>Capacity *</label>
<input type="number" id="editCapacity" placeholder="12" min="1" required>
</div>
<p style="font-size:12px;color:#666;margin-top:10px">* Required fields</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
<button class="btn btn-primary" onclick="saveOffering()">üíæ Save Changes</button>
</div>
</div>
</div>

<!-- CREATE OFFERING MODAL -->
<div id="createModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeCreateModal()">&times;</span>
<h2>Create New Offering</h2>
</div>
<div class="modal-body">
<div class="form-group">
<label>Offering Name *</label>
<input type="text" id="createName" placeholder="Math(A)" required>
</div>
<div class="form-group">
<label>Instructor/Facilitator *</label>
<input type="text" id="createInstructor" placeholder="Anna" required>
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="createLocation" placeholder="Room 101">
</div>
<div class="form-group">
<label>Days * (Hold Ctrl/Cmd to select multiple)</label>
<select id="createDays" multiple size="5" required style="height:auto">
<option value="monday">Monday</option>
<option value="tuesday">Tuesday</option>
<option value="wednesday">Wednesday</option>
<option value="thursday">Thursday</option>
<option value="friday">Friday</option>
</select>
<p style="font-size:11px;color:#666;margin-top:5px">üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple days</p>
</div>
<div class="form-group">
<label>Time Blocks * (Hold Ctrl/Cmd to select multiple)</label>
<select id="createBlocks" multiple size="6" required style="height:auto">
<option value="10:00-10:45">Block 1: 10:00-10:45 am</option>
<option value="10:50-11:35">Block 2: 10:50-11:35 am</option>
<option value="12:10-12:55">Block 3: 12:10-12:55 pm</option>
<option value="1:00-1:50">Block 4: 1:00-1:50 pm</option>
<option value="1:55-2:45">Block 5: 1:55-2:45 pm</option>
</select>
<p style="font-size:11px;color:#666;margin-top:5px">üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple blocks</p>
</div>
<div class="form-group">
<label>
<input type="checkbox" id="createMultiple" onchange="toggleMultipleCreation()">
Create separate offering for each day/block combination
</label>
<p style="font-size:11px;color:#666;margin-top:5px">
‚úì Checked: Creates individual offerings (e.g., Math(A) Mon 10:00, Math(A) Tue 10:00)<br>
‚úó Unchecked: Single offering with multiple times (e.g., Math(A) shows "Mon, Tue" and "10:00, 1:00")
</p>
</div>
<div class="form-group">
<label>Type *</label>
<select id="createType" required>
<option value="">-- Select Type --</option>
<option value="commitment">Commitment</option>
<option value="drop-in">Drop-in</option>
<option value="private">Private</option>
</select>
</div>
<div class="form-group">
<label>Level</label>
<select id="createLevel">
<option value="">All Levels</option>
<option value="acorns">Acorns</option>
<option value="canopy">Canopy</option>
<option value="canopy+">Canopy+</option>
<option value="mixed">Mixed Age</option>
</select>
</div>
<div class="form-group">
<label>Description</label>
<textarea id="createDescription" placeholder="Describe what students will learn and do in this class..." rows="4"></textarea>
</div>
<div class="form-group">
<label>Capacity *</label>
<input type="number" id="createCapacity" placeholder="12" min="1" value="12" required>
</div>
<p style="font-size:12px;color:#666;margin-top:10px">* Required fields</p>
<div id="createPreview" style="background:#f8f9fa;padding:15px;border-radius:4px;margin-top:15px;display:none">
<strong>Preview:</strong>
<div id="createPreviewText" style="margin-top:10px;font-size:13px"></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
<button class="btn btn-primary" onclick="createOffering()">‚ûï Create Offering(s)</button>
</div>
</div>
</div>

<!-- ADD STUDENT TO CLASS MODAL -->
<div id="enrollModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeEnrollModal()">&times;</span>
<h2 id="enrollModalTitle">Add Learners to Offering</h2>
</div>
<div class="modal-body">
<p id="enrollClassName" style="font-size:16px;font-weight:bold;color:#2196F3;margin-bottom:15px"></p>
<div class="form-group">
<label>Select Learners (Hold Ctrl/Cmd to select multiple)</label>
<select id="enrollStudent" multiple size="10">
<option value="">-- Loading students... --</option>
</select>
<p style="font-size:11px;color:#666;margin-top:5px">üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple learners</p>
</div>
<div id="enrollPreview" style="background:#f8f9fa;padding:10px;border-radius:4px;margin-top:10px;display:none">
<strong>Selected learners:</strong>
<div id="enrollPreviewList" style="margin-top:5px;font-size:13px"></div>
</div>
<p style="font-size:12px;color:#666;margin-top:10px">
This will add the offering to the selected learners' approved schedules.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEnrollModal()">Cancel</button>
<button class="btn btn-primary" onclick="addStudentsToClass()">‚ûï Add Learner(s)</button>
</div>
</div>
</div>

<!-- ENROLLED STUDENTS MODAL -->
<div id="enrolledModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeEnrolledModal()">&times;</span>
<h2 id="enrolledModalTitle">Enrolled Learners</h2>
</div>
<div class="modal-body">
<p id="enrolledClassName" style="font-size:18px;font-weight:bold;color:#2196F3;margin-bottom:15px"></p>
<div id="enrolledList"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEnrolledModal()">Close</button>
</div>
</div>
</div>

<!-- STUDENT SCHEDULE MODAL -->
<div id="studentScheduleModal" class="modal">
<div class="modal-content" style="max-width:1200px">
<div class="modal-header">
<span class="close" onclick="closeStudentScheduleModal()">&times;</span>
<h2 id="studentScheduleModalTitle">Learner Schedule</h2>
</div>
<div class="modal-body">
<div id="studentScheduleGrid"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeStudentScheduleModal()">Close</button>
</div>
</div>
</div>

<!-- ADD OTHER STUDENT TO ATTENDANCE MODAL -->
<div id="otherStudentModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeOtherStudentModal()">&times;</span>
<h2 id="otherStudentModalTitle">Add Other Learners to Attendance</h2>
</div>
<div class="modal-body">
<p id="otherOfferingName" style="font-size:16px;font-weight:bold;color:#2196F3;margin-bottom:15px"></p>
<div class="form-group">
<label>Select Learners (Hold Ctrl/Cmd to select multiple)</label>
<select id="otherStudentSelect" multiple size="10">
<option value="">-- Loading learners... --</option>
</select>
<p style="font-size:11px;color:#666;margin-top:5px">üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple learners</p>
</div>
<div id="otherStudentPreview" style="background:#f8f9fa;padding:10px;border-radius:4px;margin-top:10px;display:none">
<strong>Selected learners:</strong>
<div id="otherStudentPreviewList" style="margin-top:5px;font-size:13px"></div>
</div>
<p style="font-size:12px;color:#666;margin-top:10px">
These learners are not enrolled in this offering but will be marked as present.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeOtherStudentModal()">Cancel</button>
<button class="btn btn-primary" onclick="addOtherStudentsToAttendance()">‚úÖ Mark Present</button>
</div>
</div>
</div>

<script>
const API='https://script.google.com/macros/s/AKfycbwUV7DXx8J4p31M5jT5NjulaSdmWMpxdDWDogUEv4bFB2Gc5NcDGKSco9ytsmdxhNzu/exec';
let pending=[],students=[],offerings=[],allStudentNames=[];
let currentEditId=null,currentEnrollOfferingId=null;
let studentsLoaded=false,offeringsLoaded=false,attendanceLoaded=false,pendingLoaded=false;
let currentAttendanceOfferingId=null,currentAttendanceDate=null;
let attendanceData={};

// === HELPER FUNCTIONS ===
function msg(text,type){
const s=document.getElementById('status');
s.textContent=text;
s.className='status '+type;
s.style.display='block';
setTimeout(()=>s.style.display='none',3000);
}

function closeModal(id,resetVars=[]){
document.getElementById(id).style.display='none';
resetVars.forEach(v=>{if(v==='currentEditId')currentEditId=null;else if(v==='currentEnrollOfferingId')currentEnrollOfferingId=null;else if(v==='currentAttendanceOfferingId')currentAttendanceOfferingId=null;else if(v==='currentAttendanceDate')currentAttendanceDate=null});
}

function emptyState(msg){
return `<div style="text-align:center;padding:60px 20px;color:#999"><p style="font-size:18px">${msg}</p></div>`;
}

async function apiCall(action,data,onSuccess,onError){
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({action,...data})});
const d=await r.json();
if(d.success){if(onSuccess)onSuccess(d)}
else{msg(d.message||'Error','error');if(onError)onError(d)}
}catch(e){msg('‚ùå '+e.message,'error')}
}

function switchTab(i){
document.querySelectorAll('.tab-content,.tab').forEach(e=>e.classList.remove('active'));
document.querySelectorAll('.tab')[i].classList.add('active');
document.querySelectorAll('.tab-content')[i].classList.add('active');
// Initialize attendance tab on first visit (just sets date, doesn't load data)
if(i===1&&!attendanceLoaded){
const today=new Date().toISOString().split('T')[0];
document.getElementById('attendanceDate').value=today;
attendanceLoaded=true;
}
}

async function loadPendingRequests(){
try{
pendingLoaded=true;
document.getElementById('pendingContainer').innerHTML='<div class="loading"><div class="spinner"></div>Loading...</div>';
const r=await fetch(`${API}?action=getPendingRequests`);
const d=await r.json();
pending=d.requests||[];
renderPendingRequests();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderPendingRequests(){
const c=document.getElementById('pendingContainer');
if(!pending.length){c.innerHTML='<div class="empty">‚úÖ<br>No pending requests</div>';return}
const grouped={};
pending.forEach(p=>{
if(!grouped[p.studentName])grouped[p.studentName]=[];
grouped[p.studentName].push(p);
});
let html='';
Object.keys(grouped).forEach(studentName=>{
const requests=grouped[studentName];
const firstReq=requests[0];
const date=new Date(firstReq.submitted).toLocaleString();
const baseRequestId=firstReq.requestId.split('_')[0]+'_'+firstReq.requestId.split('_')[1];
html+=`<div class="request-card">
<div class="request-header">
<div><div class="request-student">${studentName}</div>
<div style="font-size:12px;color:#999">Submitted: ${date}</div></div>
<div><span class="badge badge-pending">PENDING</span></div>
</div>`;
requests.forEach(req=>{
html+=`<div class="class-row">
<div class="class-info">
<div class="class-name">${req.className}</div>
<div class="class-details">${req.dayTime}</div>
</div>
<div class="class-actions">
<button class="btn btn-success btn-small" onclick="approveClass('${req.requestId}','${req.offeringId}','${studentName}','${req.className}')">‚úì Approve</button>
<button class="btn btn-danger btn-small" onclick="denyClass('${req.requestId}','${req.offeringId}','${studentName}','${req.className}')">‚úó Deny</button>
</div>
</div>`;
});
html+=`<div class="group-actions">
<button class="btn btn-success btn-small" onclick="approveAllForStudent('${baseRequestId}','${studentName}')">‚úì Approve All (${requests.length})</button>
<button class="btn btn-danger btn-small" onclick="denyAllForStudent('${baseRequestId}','${studentName}')">‚úó Deny All</button>
</div></div>`;
});
c.innerHTML=html;
}

async function approveClass(requestId,offeringId,studentName,className){
if(!confirm(`Approve "${className}" for ${studentName}?`))return;
apiCall('approveClass',{requestId,offeringId},async()=>{
msg(`‚úÖ Approved: ${className}`,'success');
await loadPendingRequests();
await loadStudents();
});
}

async function denyClass(requestId,offeringId,studentName,className){
if(!confirm(`Deny "${className}" for ${studentName}?`))return;
apiCall('denyClass',{requestId,offeringId},async()=>{
msg(`‚úÖ Denied: ${className}`,'success');
await loadPendingRequests();
});
}
}

async function approveAllForStudent(baseRequestId,studentName){
if(!confirm(`Approve ALL classes for ${studentName}?`))return;
apiCall('approveAllClasses',{requestId:baseRequestId},async(d)=>{
msg(`‚úÖ Approved ${d.count} class(es)`,'success');
await loadPendingRequests();
await loadStudents();
});
}

async function denyAllForStudent(baseRequestId,studentName){
if(!confirm(`Deny ALL classes for ${studentName}?`))return;
apiCall('denyAllClasses',{requestId:baseRequestId},async(d)=>{
msg(`‚úÖ Denied ${d.count} class(es)`,'success');
await loadPendingRequests();
});
}

async function loadStudents(){
try{
studentsLoaded=true;
document.getElementById('studentsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadAll`);
const d=await r.json();
students=d.students||[];

// Load ALL students from Students sheet (master list) (only if not already loaded)
if(allStudentNames.length===0){
const r2=await fetch(`${API}?action=getAllStudents`);
const d2=await r2.json();
if(d2.success){
allStudentNames=d2.students||[];
}else{
// Fallback to approved students if Students sheet doesn't exist
const r3=await fetch(`${API}?action=loadStudents`);
const d3=await r3.json();
allStudentNames=d3.students?d3.students.map(name=>({id:'',name:name})):[];
}
}

renderStudents();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderStudents(){
const c=document.getElementById('studentsContainer');
if(!students.length){
c.innerHTML='<div class="empty">üë•<br>No approved students yet</div>';
return;
}

// Sort students alphabetically
const sorted=[...students].sort((a,b)=>a.name.localeCompare(b.name));

let html='<table><thead><tr><th>Name</th><th>Total Offerings</th><th>Last Updated</th><th>Actions</th></tr></thead><tbody>';
sorted.forEach(s=>{
const date=s.timestamp?new Date(s.timestamp).toLocaleDateString():'N/A';
const encodedName=s.name.replace(/'/g,"\\'");
html+=`<tr>
<td><strong>${s.name}</strong></td>
<td>${s.totalClasses||0}</td>
<td>${date}</td>
<td><button class="btn btn-secondary btn-small" onclick="showStudentSchedule('${encodedName}')">üìÖ View Schedule</button></td>
</tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

async function showStudentSchedule(studentName){
try{
const r=await fetch(`${API}?action=loadStudent&studentName=${encodeURIComponent(studentName)}`);
const d=await r.json();

document.getElementById('studentScheduleModalTitle').textContent=`${studentName}'s Schedule`;

if(!d.success||!d.offerings||d.offerings.length===0){
document.getElementById('studentScheduleGrid').innerHTML='<div style="text-align:center;padding:40px;color:#999">No offerings in schedule</div>';
document.getElementById('studentScheduleModal').style.display='block';
return;
}

// Build schedule grid
const TIMES=[
{name:'Block 1',time:'10:00-10:45'},
{name:'Block 2',time:'10:50-11:35'},
{name:'LUNCH',time:'11:35-12:05'},
{name:'Block 3',time:'12:10-12:55'},
{name:'Block 4',time:'1:00-1:50'},
{name:'Block 5',time:'1:55-2:45'}
];
const DAYS=['monday','tuesday','wednesday','thursday','friday'];

let html='<table style="width:100%;border-collapse:collapse;font-size:12px">';
html+='<thead><tr><th style="background:#4CAF50;color:white;padding:10px;border:1px solid #ddd">Time</th>';
DAYS.forEach(day=>{
html+=`<th style="background:#4CAF50;color:white;padding:10px;border:1px solid #ddd">${day.charAt(0).toUpperCase()+day.slice(1)}</th>`;
});
html+='</tr></thead><tbody>';

TIMES.forEach(block=>{
if(block.time==='11:35-12:05'){
html+=`<tr><td style="background:#ffe0b2;padding:10px;border:1px solid #ddd;font-weight:bold;text-align:center">üçΩÔ∏è ${block.name}</td>`;
html+='<td colspan="5" style="background:#fff9e6;text-align:center;color:#999;border:1px solid #ddd">Lunch Break</td></tr>';
return;
}

html+=`<tr><td style="background:#f8f9fa;padding:10px;border:1px solid #ddd;font-weight:bold;text-align:center">${block.name}<br><small style="font-weight:normal;color:#666">${block.time}</small></td>`;

DAYS.forEach(day=>{
const offering=d.offerings.find(o=>{
const offeringDays=o.day?o.day.split(',').map(d=>d.trim().toLowerCase()):[];
const offeringTimes=o.time?o.time.split(',').map(t=>t.trim()):[];
return offeringDays.includes(day)&&offeringTimes.includes(block.time);
});

if(offering){
html+=`<td style="padding:10px;border:1px solid #ddd;background:#e6f0ff">
<strong style="color:#2196F3">${offering.name}</strong><br>
<small style="color:#666">üë§ ${offering.instructor}<br>üìç ${offering.location||'TBA'}</small>
</td>`;
}else{
html+=`<td style="padding:10px;border:1px solid #ddd;text-align:center;color:#ccc">-</td>`;
}
});
html+='</tr>';
});

html+='</tbody></table>';
document.getElementById('studentScheduleGrid').innerHTML=html;
document.getElementById('studentScheduleModal').style.display='block';
}catch(e){
alert('Error loading schedule: '+e.message);
}
}

function closeStudentScheduleModal(){closeModal('studentScheduleModal')}
const studentName=document.getElementById('studentSelect').value;
const container=document.getElementById('studentsContainer');

if(!studentName){
container.innerHTML=emptyState('Select a student to view their schedule');
return;
}

try{
const r=await fetch(`${API}?action=loadStudent&studentName=${encodeURIComponent(studentName)}`);
const d=await r.json();

if(!d.success||!d.offerings||d.offerings.length===0){
container.innerHTML=`<div style="text-align:center;padding:60px 20px;color:#999"><p style="font-size:18px">${studentName} has no approved offerings yet</p></div>`;
return;
}

const studentOfferings=d.offerings;

// Build schedule grid
const TIMES=[
{name:'Block 1',time:'10:00-10:45',display:'10:00-10:45 am'},
{name:'Block 2',time:'10:50-11:35',display:'10:50-11:35 am'},
{name:'üçΩÔ∏è LUNCH',time:'11:35-12:05',display:'11:35 am-12:05 pm'},
{name:'Block 3',time:'12:10-12:55',display:'12:10-12:55 pm'},
{name:'Block 4',time:'1:00-1:50',display:'1:00-1:50 pm'},
{name:'Block 5',time:'1:55-2:45',display:'1:55-2:45 pm'}
];
const DAYS=['monday','tuesday','wednesday','thursday','friday'];

let html=`<h3 style="text-align:center;color:#2196F3;margin:20px 0">${studentName}'s Schedule</h3>`;
html+=`<table class="student-schedule-table"><thead><tr>`;
html+=`<th class="time-col">Time</th>`;
DAYS.forEach(day=>{
html+=`<th>${day.charAt(0).toUpperCase()+day.slice(1)}</th>`;
});
html+=`</tr></thead><tbody>`;

TIMES.forEach(block=>{
if(block.time==='11:35-12:05'){
// Lunch row
html+=`<tr><td class="time-col" style="background:#ffe0b2"><strong>${block.name}</strong><br><small>${block.display}</small></td>`;
html+=`<td colspan="5" style="background:#fff9e6;text-align:center;color:#999">Lunch Break</td></tr>`;
return;
}

html+=`<tr><td class="time-col"><strong>${block.name}</strong><br><small>${block.display}</small></td>`;
DAYS.forEach(day=>{
const cell=`<td>`;
// Find offerings for this day/time
const dayOfferings=studentOfferings.filter(o=>{
const offeringDays=o.day?o.day.split(',').map(d=>d.trim().toLowerCase()):[];
const offeringTimes=o.time?o.time.split(',').map(t=>t.trim()):[];
return offeringDays.includes(day)&&offeringTimes.includes(block.time);
});

if(dayOfferings.length===0){
html+=`${cell}<div style="color:#ccc;text-align:center;padding:10px">-</div></td>`;
}else{
html+=cell;
dayOfferings.forEach(o=>{
html+=`<div class="student-offering-card">
<div class="student-offering-name">${o.name}</div>
<div class="student-offering-info">
üë§ ${o.instructor}<br>
üìç ${o.location||'TBA'}
</div>
</div>`;
});
html+=`</td>`;
}
});
html+=`</tr>`;
});

html+=`</tbody></table>`;
container.innerHTML=html;

}catch(e){
container.innerHTML=`<div style="text-align:center;padding:60px 20px;color:#999"><p>Error loading schedule: ${e.message}</p></div>`;
}
}

async function loadOfferings(){
try{
offeringsLoaded=true;
document.getElementById('offeringsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadOfferings`);
const d=await r.json();
offerings=d.offerings||[];
document.getElementById('totalOfferings').textContent=offerings.length;

// Also load students to calculate enrollment (only if not already loaded)
if(students.length===0){
const r2=await fetch(`${API}?action=loadAll`);
const d2=await r2.json();
students=d2.students||[];
}

// Load ALL students from Students sheet (master list) for dropdown (only if not already loaded)
if(allStudentNames.length===0){
const r3=await fetch(`${API}?action=getAllStudents`);
const d3=await r3.json();
if(d3.success){
allStudentNames=d3.students||[];
}else{
// Fallback to approved students if Students sheet doesn't exist
const r4=await fetch(`${API}?action=loadStudents`);
const d4=await r4.json();
allStudentNames=d4.students?d4.students.map(name=>({id:'',name:name})):[];
}
}

renderOfferings();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function getEnrolledStudents(offeringId){
const enrolled=[];
students.forEach(s=>{
try{
const classes=JSON.parse(s.classes||'[]');
if(classes.includes(offeringId)){
enrolled.push(s.name);
}
}catch(e){}
});
return enrolled;
}

function applyOfferingFilters(){
renderOfferings();
}

function getFilteredAndSortedOfferings(){
const sortBy=document.getElementById('sortBy').value;
const filterType=document.getElementById('filterType').value;
const filterLevel=document.getElementById('filterLevel').value;
const filterDay=document.getElementById('filterDay').value;

// Filter
let filtered=offerings.filter(o=>{
if(filterType&&o.type!==filterType)return false;
if(filterLevel&&o.level!==filterLevel)return false;
if(filterDay){
const days=o.day.split(',').map(d=>d.trim().toLowerCase());
if(!days.includes(filterDay))return false;
}
return true;
});

// Sort
if(sortBy==='name'){
filtered.sort((a,b)=>a.name.localeCompare(b.name));
}else if(sortBy==='instructor'){
filtered.sort((a,b)=>a.instructor.localeCompare(b.instructor));
}else if(sortBy==='type'){
filtered.sort((a,b)=>a.type.localeCompare(b.type));
}else if(sortBy==='level'){
filtered.sort((a,b)=>(a.level||'').localeCompare(b.level||''));
}else if(sortBy==='enrollment'){
filtered.sort((a,b)=>{
const enrollA=getEnrolledStudents(a.id).length;
const enrollB=getEnrolledStudents(b.id).length;
return enrollB-enrollA;
});
}else{
// Default: sort by day then time
filtered.sort((a,b)=>{
const dayOrder=['monday','tuesday','wednesday','thursday','friday'];
const dayA=dayOrder.indexOf(a.day.split(',')[0].trim().toLowerCase());
const dayB=dayOrder.indexOf(b.day.split(',')[0].trim().toLowerCase());
if(dayA!==dayB)return dayA-dayB;
return a.time.localeCompare(b.time);
});
}

return filtered;
}

function renderOfferings(){
const c=document.getElementById('offeringsContainer');
const filtered=getFilteredAndSortedOfferings();

if(filtered.length===0){
c.innerHTML='<div class="empty">üìö<br>No offerings match your filters</div>';
return;
}

let html='<table><thead><tr><th>Name</th><th>Instructor</th><th>Day</th><th>Time</th><th>Type</th><th>Enrolled</th><th>Actions</th></tr></thead><tbody>';
filtered.forEach(o=>{
const day=o.day.charAt(0).toUpperCase()+o.day.slice(1);
const enrolled=getEnrolledStudents(o.id);
const capacity=o.capacity||999;
const enrolledCount=enrolled.length;
const isFull=enrolledCount>=capacity;
const enrolledBtn=enrolledCount>0?
`<button class="btn btn-secondary btn-small" onclick="showEnrolledModal(${o.id},'${o.name}')">${enrolledCount}/${capacity} üë•</button>`:
`<span style="color:#999">${enrolledCount}/${capacity}</span>`;

html+=`<tr style="${isFull?'background:#ffe6e6':''}">
<td><strong>${o.name}</strong></td>
<td class="editable-cell" onclick="quickEditInstructor(${o.id},'${o.instructor}')">${o.instructor} <span class="edit-icon">‚úèÔ∏è</span></td>
<td>${day}</td>
<td style="font-size:11px">${o.time}</td>
<td>${o.type}</td>
<td>${enrolledBtn}</td>
<td>
<button class="btn btn-warning btn-small" onclick="editOffering(${o.id})">‚úèÔ∏è Edit</button>
<button class="btn btn-primary btn-small" onclick="showEnrollModal(${o.id},'${o.name}')">‚ûï Add</button>
</td>
</tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

function quickEditInstructor(id,currentName){
const newName=prompt('Edit Instructor Name:',currentName);
if(newName&&newName!==currentName){
updateOfferingField(id,'instructor',newName);
}
}

async function updateOfferingField(id,field,value){
try{
const offering=offerings.find(o=>o.id===id);
if(!offering)return;
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'updateOffering',
offeringId:id,
name:offering.name,
instructor:field==='instructor'?value:offering.instructor,
location:offering.location,
day:offering.day,
time:offering.time,
type:offering.type,
level:offering.level,
description:offering.description,
capacity:offering.capacity
})});
const d=await r.json();
if(d.success){
msg('‚úÖ Updated instructor','success');
await loadOfferings();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

function editOffering(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
currentEditId=id;
document.getElementById('editModalTitle').textContent='Edit: '+o.name;
document.getElementById('editName').value=o.name;
document.getElementById('editInstructor').value=o.instructor;
document.getElementById('editLocation').value=o.location||'';
document.getElementById('editDay').value=o.day;
document.getElementById('editTime').value=o.time;
document.getElementById('editType').value=o.type;
document.getElementById('editLevel').value=o.level||'';
document.getElementById('editDescription').value=o.description||'';
document.getElementById('editCapacity').value=o.capacity||12;
document.getElementById('editModal').style.display='block';
}

function closeEditModal(){closeModal('editModal',['currentEditId'])}

function showCreateOfferingModal(){
document.getElementById('createName').value='';
document.getElementById('createInstructor').value='';
document.getElementById('createLocation').value='';
document.getElementById('createDays').selectedIndex=-1;
document.getElementById('createBlocks').selectedIndex=-1;
document.getElementById('createMultiple').checked=false;
document.getElementById('createType').value='';
document.getElementById('createLevel').value='';
document.getElementById('createDescription').value='';
document.getElementById('createCapacity').value='12';
document.getElementById('createPreview').style.display='none';
document.getElementById('createModal').style.display='block';
}

function closeCreateModal(){closeModal('createModal')}

function toggleMultipleCreation(){
updateCreatePreview();
}

function updateCreatePreview(){
const daysSelect=document.getElementById('createDays');
const blocksSelect=document.getElementById('createBlocks');
const multiple=document.getElementById('createMultiple').checked;
const name=document.getElementById('createName').value.trim();

const selectedDays=Array.from(daysSelect.selectedOptions).map(o=>o.text);
const selectedBlocks=Array.from(blocksSelect.selectedOptions).map(o=>o.value);

if(selectedDays.length>0&&selectedBlocks.length>0){
const preview=document.getElementById('createPreview');
const previewText=document.getElementById('createPreviewText');
preview.style.display='block';

if(multiple){
const count=selectedDays.length*selectedBlocks.length;
previewText.innerHTML=`<strong>Will create ${count} separate offering(s):</strong><br>`;
selectedDays.forEach(day=>{
selectedBlocks.forEach(block=>{
previewText.innerHTML+=`‚Ä¢ ${name||'[Class]'} - ${day} ${block}<br>`;
});
});
}else{
previewText.innerHTML=`<strong>Will create 1 offering:</strong><br>`;
previewText.innerHTML+=`‚Ä¢ ${name||'[Class]'} - Days: ${selectedDays.join(', ')}<br>`;
previewText.innerHTML+=`‚Ä¢ Times: ${selectedBlocks.join(', ')}`;
}
}else{
document.getElementById('createPreview').style.display='none';
}
}

// Add event listeners for preview
document.addEventListener('DOMContentLoaded',()=>{
if(document.getElementById('createDays')){
document.getElementById('createDays').addEventListener('change',updateCreatePreview);
document.getElementById('createBlocks').addEventListener('change',updateCreatePreview);
document.getElementById('createName').addEventListener('input',updateCreatePreview);
}
});

async function createOffering(){
const name=document.getElementById('createName').value.trim();
const instructor=document.getElementById('createInstructor').value.trim();
const type=document.getElementById('createType').value;

const daysSelect=document.getElementById('createDays');
const blocksSelect=document.getElementById('createBlocks');
const selectedDays=Array.from(daysSelect.selectedOptions).map(o=>o.value);
const selectedBlocks=Array.from(blocksSelect.selectedOptions).map(o=>o.value);
const createMultiple=document.getElementById('createMultiple').checked;

if(!name||!instructor||selectedDays.length===0||selectedBlocks.length===0||!type){
alert('Please fill in all required fields:\n- Class Name\n- Instructor\n- At least one Day\n- At least one Time Block\n- Type');
return;
}

const baseData={
name:name,
instructor:instructor,
location:document.getElementById('createLocation').value.trim(),
type:type,
level:document.getElementById('createLevel').value,
description:document.getElementById('createDescription').value.trim(),
capacity:parseInt(document.getElementById('createCapacity').value)||12
};

try{
if(createMultiple){
// Create separate offering for each day/block combination
let created=0;
for(const day of selectedDays){
for(const block of selectedBlocks){
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'saveOffering',
...baseData,
day:day,
time:block
})});
const d=await r.json();
if(d.success)created++;
}
}
msg(`‚úÖ Created ${created} offering(s)!`,'success');
closeCreateModal();
await loadOfferings();
}else{
// Create single offering with multiple days/blocks
const days=selectedDays.join(',');
const times=selectedBlocks.join(',');
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'saveOffering',
...baseData,
day:days,
time:times
})});
const d=await r.json();
if(d.success){
msg(`‚úÖ Created: ${name}`,'success');
closeCreateModal();
await loadOfferings();
}else{
msg('‚ùå '+d.message,'error');
}
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function saveOffering(){
if(!currentEditId)return;
const o=offerings.find(of=>of.id===currentEditId);
if(!o)return;

const name=document.getElementById('editName').value.trim();
const instructor=document.getElementById('editInstructor').value.trim();
const day=document.getElementById('editDay').value;
const time=document.getElementById('editTime').value.trim();
const type=document.getElementById('editType').value;

if(!name||!instructor||!day||!time||!type){
alert('Please fill in all required fields (marked with *)');
return;
}

try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'updateOffering',
offeringId:currentEditId,
name:name,
instructor:instructor,
location:document.getElementById('editLocation').value.trim(),
day:day,
time:time,
type:type,
level:document.getElementById('editLevel').value,
description:document.getElementById('editDescription').value.trim(),
capacity:parseInt(document.getElementById('editCapacity').value)||12
})});
const d=await r.json();
if(d.success){
msg('‚úÖ Offering updated','success');
closeEditModal();
await loadOfferings();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

function showEnrollModal(offeringId,offeringName){
currentEnrollOfferingId=offeringId;
document.getElementById('enrollModalTitle').textContent='Add Learners to Offering';
document.getElementById('enrollClassName').textContent=offeringName;
const select=document.getElementById('enrollStudent');
select.innerHTML='';

// Sort students by name
const sortedStudents=[...allStudentNames].sort((a,b)=>{
const nameA=a.name||a;
const nameB=b.name||b;
return nameA.localeCompare(nameB);
});

sortedStudents.forEach(student=>{
const name=student.name||student;
const id=student.id||'';
const grade=student.grade||'';
const level=student.level||'';
let displayText=name;
if(id)displayText+=` (ID: ${id})`;
if(grade)displayText+=` - Grade ${grade}`;
if(level)displayText+=` - ${level}`;
select.innerHTML+=`<option value="${name}" data-id="${id}">${displayText}</option>`;
});

// Add event listener for preview
select.addEventListener('change',updateEnrollPreview);
document.getElementById('enrollPreview').style.display='none';
document.getElementById('enrollModal').style.display='block';
}

function updateEnrollPreview(){
const select=document.getElementById('enrollStudent');
const selectedOptions=Array.from(select.selectedOptions);
const preview=document.getElementById('enrollPreview');
const previewList=document.getElementById('enrollPreviewList');

if(selectedOptions.length>0){
preview.style.display='block';
previewList.innerHTML=selectedOptions.map((opt,i)=>`${i+1}. ${opt.text}`).join('<br>');
}else{
preview.style.display='none';
}
}

function closeEnrollModal(){closeModal('enrollModal',['currentEnrollOfferingId'])}

function showEnrolledModal(offeringId,offeringName){
const offering=offerings.find(o=>o.id===offeringId);
const enrolled=getEnrolledStudents(offeringId);
const capacity=offering?offering.capacity||999:999;

document.getElementById('enrolledModalTitle').textContent='Enrolled Learners';
document.getElementById('enrolledClassName').textContent=offeringName;

let html='<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px">';
html+=`<p style="margin:0"><strong>Enrolled:</strong> ${enrolled.length} / ${capacity}</p>`;
if(enrolled.length>=capacity){
html+=`<p style="margin:5px 0 0;color:#d32f2f;font-weight:bold">‚ö†Ô∏è CLASS IS FULL</p>`;
}else{
html+=`<p style="margin:5px 0 0;color:#4CAF50">${capacity-enrolled.length} spot(s) remaining</p>`;
}
html+='</div>';

if(enrolled.length===0){
html+='<p style="text-align:center;color:#999;padding:40px 20px">No learners enrolled yet</p>';
}else{
html+='<div style="max-height:400px;overflow-y:auto">';
enrolled.sort().forEach((name,index)=>{
html+=`<div style="background:white;padding:12px;margin:5px 0;border-radius:4px;border-left:3px solid #2196F3;display:flex;justify-content:space-between;align-items:center">
<div><strong>${index+1}. ${name}</strong></div>
<button class="btn btn-danger btn-small" onclick="removeStudentFromClass('${name}',${offeringId},'${offeringName}')">‚úó Remove</button>
</div>`;
});
html+='</div>';
}

document.getElementById('enrolledList').innerHTML=html;
document.getElementById('enrolledModal').style.display='block';
}

function closeEnrolledModal(){closeModal('enrolledModal')}

async function removeStudentFromClass(studentName,offeringId,className){
if(!confirm(`Remove ${studentName} from ${className}?`))return;
apiCall('removeEnrollment',{studentName,offeringId},async()=>{
msg(`‚úÖ Removed ${studentName}`,'success');
await loadStudents();
await loadOfferings();
closeEnrolledModal();
});
}

async function addStudentsToClass(){
const select=document.getElementById('enrollStudent');
const selectedStudents=Array.from(select.selectedOptions).map(opt=>opt.value);

if(selectedStudents.length===0){
alert('Please select at least one learner');
return;
}
if(!currentEnrollOfferingId)return;

const count=selectedStudents.length;
const studentText=count===1?selectedStudents[0]:`${count} learners`;
if(!confirm(`Add ${studentText} to this offering?`))return;

try{
let succeeded=0;
let failed=0;
const errors=[];

for(const studentName of selectedStudents){
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'manualEnroll',
studentName:studentName,
offeringId:currentEnrollOfferingId
})});
const d=await r.json();
if(d.success){
succeeded++;
}else{
failed++;
errors.push(`${studentName}: ${d.message}`);
}
}

if(succeeded>0){
msg(`‚úÖ Added ${succeeded} learner(s) to offering`,'success');
await loadStudents();
await loadOfferings();
}
if(failed>0){
msg(`‚ö†Ô∏è ${failed} failed: ${errors.join(', ')}`,'error');
}
if(succeeded>0){
closeEnrollModal();
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

// ATTENDANCE FUNCTIONS

function loadAttendanceTab(){
// Set today's date
const today=new Date().toISOString().split('T')[0];
document.getElementById('attendanceDate').value=today;

// Check if offerings are loaded
if(offerings.length===0){
document.getElementById('attendanceContainer').innerHTML=emptyState('Please load Offerings first (go to Offerings tab and click Refresh)');
return;
}

// Populate offerings dropdown
const select=document.getElementById('attendanceOffering');
select.innerHTML='<option value="">-- Select Offering --</option>';
offerings.forEach(o=>{
const day=o.day.charAt(0).toUpperCase()+o.day.slice(1);
select.innerHTML+=`<option value="${o.id}">${o.name} - ${day} ${o.time}</option>`;
});

loadAttendanceForDate();
}

async function loadAttendanceForDate(){
const date=document.getElementById('attendanceDate').value;
if(!date)return;

try{
const r=await fetch(`${API}?action=getAttendance&date=${date}`);
const d=await r.json();
attendanceData=d.attendance||{};
loadAttendanceRoster();
}catch(e){
console.error('Error loading attendance:',e);
attendanceData={};
}
}

function loadAttendanceRoster(){
const offeringId=document.getElementById('attendanceOffering').value;
const date=document.getElementById('attendanceDate').value;
const container=document.getElementById('attendanceContainer');

if(!offeringId||!date){
container.innerHTML=emptyState('Select a date and class to mark attendance');
return;
}

const offering=offerings.find(o=>o.id==offeringId);
if(!offering){
container.innerHTML=emptyState('Offering not found');
return;
}

const enrolled=getEnrolledStudents(offeringId);
const key=`${date}_${offeringId}`;
const presentList=attendanceData[key]||[];

// Default: all enrolled students are checked (present) unless marked absent
let studentStatuses=new Map();

// First, mark all enrolled students as present by default
enrolled.forEach(name=>{
studentStatuses.set(name,{enrolled:true,present:true});
});

// Then update based on actual attendance data if it exists
if(presentList.length>0){
// If we have attendance data, respect it
enrolled.forEach(name=>{
studentStatuses.set(name,{enrolled:true,present:presentList.includes(name)});
});
// Check for other students who attended
presentList.forEach(name=>{
if(!enrolled.includes(name)){
studentStatuses.set(name,{enrolled:false,present:true});
}
});
}

const totalPresent=Array.from(studentStatuses.values()).filter(s=>s.present).length;
const totalAbsent=Array.from(studentStatuses.values()).filter(s=>!s.present).length;

let html=`<div class="attendance-summary">
<div>
<strong style="font-size:16px">${offering.name}</strong><br>
<span style="font-size:13px;color:#666">${new Date(date).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</span>
</div>
<div style="flex:1"></div>
<div class="attendance-stat">
<div class="attendance-stat-number" style="color:#4CAF50">${totalPresent}</div>
<div class="attendance-stat-label">Present</div>
</div>
<div class="attendance-stat">
<div class="attendance-stat-number" style="color:#999">${totalAbsent}</div>
<div class="attendance-stat-label">Absent</div>
</div>
<div class="attendance-stat">
<div class="attendance-stat-number">${enrolled.length}</div>
<div class="attendance-stat-label">Enrolled</div>
</div>
<button class="btn btn-secondary btn-small" onclick="showAddOtherStudentModal(${offeringId},'${date}')" style="margin-left:15px">‚ûï Add Other Student</button>
</div>`;

if(studentStatuses.size===0){
html+='<div style="text-align:center;padding:60px 20px;color:#999"><p style="font-size:18px">No students enrolled in this offering</p></div>';
container.innerHTML=html;
return;
}

html+='<div class="attendance-roster">';
// Sort: enrolled first, then other
const sortedStudents=Array.from(studentStatuses.entries()).sort((a,b)=>{
if(a[1].enrolled&&!b[1].enrolled)return -1;
if(!a[1].enrolled&&b[1].enrolled)return 1;
return a[0].localeCompare(b[0]);
});

sortedStudents.forEach(([studentName,status])=>{
const isPresent=status.present;
const isEnrolled=status.enrolled;
html+=`<div class="attendance-card ${isPresent?'present':'absent'}">
<input type="checkbox" class="attendance-checkbox" ${isPresent?'checked':''} 
onchange="toggleAttendance('${studentName}',${offeringId},'${date}',this.checked)">
<div style="flex:1">
<div class="attendance-name">${studentName}</div>
${!isEnrolled?'<div class="attendance-info" style="color:#ff9800;font-weight:600">‚ö†Ô∏è Other</div>':''}
</div>
${!isEnrolled?`<button class="btn btn-danger btn-small" onclick="removeOtherAttendance('${studentName}',${offeringId},'${date}')" style="margin-left:10px">‚úó</button>`:''}
</div>`;
});
html+='</div>';

container.innerHTML=html;
}

let currentAttendanceOfferingId=null;
let currentAttendanceDate=null;

function showAddOtherStudentModal(offeringId,date){
currentAttendanceOfferingId=offeringId;
currentAttendanceDate=date;

const offering=offerings.find(o=>o.id==offeringId);
const enrolled=getEnrolledStudents(offeringId);

document.getElementById('otherStudentModalTitle').textContent='Add Other Student to Attendance';
document.getElementById('otherOfferingName').textContent=offering?offering.name:'';

const select=document.getElementById('otherStudentSelect');
select.innerHTML='';

// Sort all students, filter out already enrolled
const sortedStudents=[...allStudentNames].sort((a,b)=>{
const nameA=a.name||a;
const nameB=b.name||b;
return nameA.localeCompare(nameB);
});

sortedStudents.forEach(student=>{
const name=student.name||student;
// Skip if already enrolled
if(enrolled.includes(name))return;

const id=student.id||'';
const grade=student.grade||'';
const level=student.level||'';
let displayText=name;
if(id)displayText+=` (ID: ${id})`;
if(grade)displayText+=` - Grade ${grade}`;
if(level)displayText+=` - ${level}`;
select.innerHTML+=`<option value="${name}">${displayText}</option>`;
});

select.addEventListener('change',updateOtherStudentPreview);
document.getElementById('otherStudentPreview').style.display='none';
document.getElementById('otherStudentModal').style.display='block';
}

function updateOtherStudentPreview(){
const select=document.getElementById('otherStudentSelect');
const selectedOptions=Array.from(select.selectedOptions);
const preview=document.getElementById('otherStudentPreview');
const previewList=document.getElementById('otherStudentPreviewList');

if(selectedOptions.length>0){
preview.style.display='block';
previewList.innerHTML=selectedOptions.map((opt,i)=>`${i+1}. ${opt.text}`).join('<br>');
}else{
preview.style.display='none';
}
}


function closeOtherStudentModal(){closeModal("otherStudentModal",["currentAttendanceOfferingId","currentAttendanceDate"])}





async function addOtherStudentsToAttendance(){
const select=document.getElementById('otherStudentSelect');
const selectedStudents=Array.from(select.selectedOptions).map(opt=>opt.value);

if(selectedStudents.length===0){
alert('Please select at least one student');
return;
}

const count=selectedStudents.length;
const studentText=count===1?selectedStudents[0]:`${count} students`;
if(!confirm(`Mark ${studentText} as present (other)?`))return;

try{
for(const studentName of selectedStudents){
await toggleAttendance(studentName,currentAttendanceOfferingId,currentAttendanceDate,true);
}
msg(`‚úÖ Added ${count} other student(s) to attendance`,'success');
closeOtherStudentModal();
}catch(e){
msg('‚ùå '+e.message,'error');
}
}

let currentAttendanceOfferingId=null;
let currentAttendanceDate=null;

function showAddOtherModal(offeringId,date){
currentAttendanceOfferingId=offeringId;
currentAttendanceDate=date;

const offering=offerings.find(o=>o.id==offeringId);
const offeringName=offering?offering.name:'Unknown';

document.getElementById('otherStudentModalTitle').textContent='Add Other Learners to Attendance';
document.getElementById('otherOfferingName').textContent=offeringName;

const enrolled=getEnrolledStudents(offeringId);
const other=allStudentNames.filter(s=>{
const name=s.name||s;
return !enrolled.includes(name);
});

const select=document.getElementById('otherStudentSelect');
select.innerHTML='';

if(other.length===0){
select.innerHTML='<option value="">All learners are enrolled</option>';
document.getElementById('otherStudentModal').style.display='block';
return;
}

// Sort and populate
const sorted=[...other].sort((a,b)=>{
const nameA=a.name||a;
const nameB=b.name||b;
return nameA.localeCompare(nameB);
});

sorted.forEach(student=>{
const name=student.name||student;
const id=student.id||'';
const grade=student.grade||'';
const level=student.level||'';
let displayText=name;
if(id)displayText+=` (ID: ${id})`;
if(grade)displayText+=` - Grade ${grade}`;
if(level)displayText+=` - ${level}`;
select.innerHTML+=`<option value="${name}">${displayText}</option>`;
});

// Add event listener for preview
select.addEventListener('change',updateOtherStudentPreview);
document.getElementById('otherStudentPreview').style.display='none';
document.getElementById('otherStudentModal').style.display='block';
}

function updateOtherStudentPreview(){
const select=document.getElementById('otherStudentSelect');
const selectedOptions=Array.from(select.selectedOptions);
const preview=document.getElementById('otherStudentPreview');
const previewList=document.getElementById('otherStudentPreviewList');

if(selectedOptions.length>0){
preview.style.display='block';
previewList.innerHTML=selectedOptions.map((opt,i)=>`${i+1}. ${opt.text}`).join('<br>');
}else{
preview.style.display='none';
}
}

function closeOtherStudentModal(){
document.getElementById('otherStudentModal').style.display='none';
currentAttendanceOfferingId=null;
currentAttendanceDate=null;
}

async function addOtherStudentsToAttendance(){
const select=document.getElementById('otherStudentSelect');
const selectedStudents=Array.from(select.selectedOptions).map(opt=>opt.value);

if(selectedStudents.length===0){
alert('Please select at least one student');
return;
}

if(!currentAttendanceOfferingId||!currentAttendanceDate)return;

try{
let succeeded=0;
let failed=0;

for(const studentName of selectedStudents){
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'markAttendance',
studentName:studentName,
offeringId:currentAttendanceOfferingId,
date:currentAttendanceDate,
present:true
})});
const d=await r.json();
if(d.success){
succeeded++;
// Update local data
const key=`${currentAttendanceDate}_${currentAttendanceOfferingId}`;
if(!attendanceData[key])attendanceData[key]=[];
if(!attendanceData[key].includes(studentName)){
attendanceData[key].push(studentName);
}
}else{
failed++;
}
}

if(succeeded>0){
msg(`‚úÖ Added ${succeeded} other learner(s) to attendance`,'success');
closeOtherStudentModal();
loadAttendanceRoster();
}
if(failed>0){
msg(`‚ö†Ô∏è ${failed} failed to add`,'error');
}
}catch(e){
msg('‚ùå '+e.message,'error');
}
}

function removeOtherAttendance(studentName,offeringId,date){
if(!confirm(`Remove ${studentName} from attendance? (They are not enrolled in this offering)`))return;
toggleAttendance(studentName,offeringId,date,false);
}

async function toggleAttendance(studentName,offeringId,date,isPresent){
apiCall('markAttendance',{studentName,offeringId,date,present:isPresent},()=>{
// Update local data
const key=`${date}_${offeringId}`;
if(!attendanceData[key])attendanceData[key]=[];
if(isPresent){
if(!attendanceData[key].includes(studentName))attendanceData[key].push(studentName);
}else{
attendanceData[key]=attendanceData[key].filter(n=>n!==studentName);
}
loadAttendanceRoster();
},()=>loadAttendanceRoster());
}

window.onclick=e=>{
if(e.target.classList.contains('modal'))e.target.style.display='none';
}

// Load instantly - no API calls on startup
window.onload=()=>{};
</script>
</body>
</html>

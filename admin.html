<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Admin - Canopy Program</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2196F3;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 18px;
            color: #666;
            text-align: center;
            margin: 0 0 20px 0;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            gap: 5px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background-color: #f0f0f0;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
        }
        
        .tab:hover {
            background-color: #e0e0e0;
        }
        
        .tab.active {
            background-color: white;
            border-bottom: 3px solid #2196F3;
            color: #2196F3;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        .status-message {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0;
            font-size: 32px;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            flex: 1;
            max-width: 600px;
            flex-wrap: wrap;
        }

        .search-box input,
        .search-box select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-box input {
            flex: 1;
            min-width: 200px;
        }

        .search-box select {
            min-width: 120px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background-color: #45a049;
        }

        .btn-secondary {
            background-color: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #0b7dda;
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #da190b;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

        .data-table th {
            background-color: #4CAF50;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .data-table tr:hover {
            background-color: #e3f2fd;
        }

        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-commitment {
            background-color: #ffcdd2;
            color: #c62828;
        }

        .type-drop-in {
            background-color: #c8e6c9;
            color: #2e7d32;
        }

        .type-private {
            background-color: #ffe0b2;
            color: #e65100;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: white;
            text-align: left;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .student-detail {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .student-detail h3 {
            margin: 0 0 10px 0;
            color: #2196F3;
        }

        .class-list {
            margin-top: 10px;
        }

        .class-item {
            background-color: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #2196F3;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
            }

            .search-box {
                max-width: 100%;
                flex-direction: column;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Canopy Program - Admin Dashboard</h1>
        <h2>Session 3 (2025-2026)</h2>

        <div id="statusMessage" class="status-message"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('students')">üë• Students</button>
            <button class="tab" onclick="switchTab('offerings')">üìö Offerings</button>
        </div>

        <!-- STUDENTS TAB -->
        <div id="students" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalStudents">0</h3>
                    <p>Total Students</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 id="totalEnrollments">0</h3>
                    <p>Total Enrollments</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="avgClasses">0</h3>
                    <p>Avg Classes/Student</p>
                </div>
            </div>

            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchStudents" placeholder="Search students...">
                </div>
                <button class="btn btn-secondary" onclick="loadStudents()">üîÑ Refresh</button>
            </div>

            <div id="studentsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading students...</p>
                </div>
            </div>
        </div>

        <!-- OFFERINGS TAB -->
        <div id="offerings" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalOfferings">0</h3>
                    <p>Total Offerings</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h3 id="totalInstructors">0</h3>
                    <p>Instructors</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="commitmentCount">0</h3>
                    <p>Commitment Classes</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <h3 id="dropInCount">0</h3>
                    <p>Drop-in Classes</p>
                </div>
            </div>

            <div class="header-actions">
                <div class="search-box">
                    <input type="text" id="searchOfferings" placeholder="Search offerings...">
                    <select id="filterDay">
                        <option value="">All Days</option>
                        <option value="monday">Monday</option>
                        <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                    </select>
                    <select id="filterTime">
                        <option value="">All Times</option>
                        <option value="10:00-10:45">Block 1</option>
                        <option value="10:50-11:35">Block 2</option>
                        <option value="11:35-12:05">Lunch</option>
                        <option value="12:10-12:55">Block 3</option>
                        <option value="1:00-1:50">Block 4</option>
                        <option value="1:55-2:45">Block 5</option>
                    </select>
                    <select id="filterType">
                        <option value="">All Types</option>
                        <option value="commitment">Commitment</option>
                        <option value="drop-in">Drop-in</option>
                        <option value="private">Private</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="loadOfferings()" title="Refresh data from Google Sheets">üîÑ Refresh</button>
                <button class="btn btn-primary" onclick="showAddOfferingModal()">+ Add Offering</button>
            </div>

            <div id="offeringsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading offerings...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Offering Modal -->
    <div id="offeringModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeOfferingModal()">&times;</span>
                <h2 id="offeringModalTitle">Add New Offering</h2>
            </div>
            <div class="modal-body">
                <form id="offeringForm">
                    <input type="hidden" id="offeringId">
                    
                    <div class="form-group">
                        <label for="offeringName">Offering Name *</label>
                        <input type="text" id="offeringName" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="instructor">Facilitators * (select all that apply)</label>
                            <select id="instructor" multiple size="6" required style="height: auto;">
                                <option value="Amber">Amber</option>
                                <option value="Anna">Anna</option>
                                <option value="Ashlyn">Ashlyn</option>
                                <option value="Doug">Doug</option>
                                <option value="Elliott">Elliott</option>
                                <option value="Geoff">Geoff</option>
                                <option value="Grace">Grace</option>
                                <option value="Jamie">Jamie</option>
                                <option value="Jenique">Jenique</option>
                                <option value="Lacy">Lacy</option>
                                <option value="Nancy">Nancy</option>
                                <option value="Penny">Penny</option>
                                <option value="Tiff">Tiff</option>
                                <option value="Travis">Travis</option>
                            </select>
                            <small style="color: #666; font-size: 11px;">Hold Ctrl/Cmd to select multiple</small>
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" placeholder="e.g., JR, AR, CS">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Days * (select all that apply)</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; padding: 10px; border: 2px solid #ddd; border-radius: 4px;">
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="days" value="monday" style="width: auto;">
                                    Monday
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="days" value="tuesday" style="width: auto;">
                                    Tuesday
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="days" value="wednesday" style="width: auto;">
                                    Wednesday
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="days" value="thursday" style="width: auto;">
                                    Thursday
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="days" value="friday" style="width: auto;">
                                    Friday
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Time Blocks * (select all that apply)</label>
                            <div style="display: flex; flex-direction: column; gap: 8px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="timeBlocks" value="10:00-10:45" style="width: auto;">
                                    Block 1 (10:00-10:45 am)
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="timeBlocks" value="10:50-11:35" style="width: auto;">
                                    Block 2 (10:50-11:35 am)
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="timeBlocks" value="11:35-12:05" style="width: auto;">
                                    üçΩÔ∏è Lunch (11:35 am-12:05 pm)
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="timeBlocks" value="12:10-12:55" style="width: auto;">
                                    Block 3 (12:10-12:55 pm)
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="timeBlocks" value="1:00-1:50" style="width: auto;">
                                    Block 4 (1:00-1:50 pm)
                                </label>
                                <label style="font-weight: normal; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" name="timeBlocks" value="1:55-2:45" style="width: auto;">
                                    Block 5 (1:55-2:45 pm)
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="offeringType">Type *</label>
                            <select id="offeringType" required>
                                <option value="">Select type</option>
                                <option value="commitment">Commitment</option>
                                <option value="drop-in">Drop-in</option>
                                <option value="private">Private</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="level">Student Levels (select all that apply)</label>
                            <select id="level" multiple size="5" style="height: auto;">
                                <option value="All">All Ages</option>
                                <option value="EC">Early Childhood (EC)</option>
                                <option value="Saplings">Saplings</option>
                                <option value="Acorns">Acorns</option>
                                <option value="Canopy">Canopy</option>
                            </select>
                            <small style="color: #666; font-size: 11px;">Hold Ctrl/Cmd to select multiple</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" placeholder="What is this class about?"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOfferingModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOffering()">Save</button>
            </div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeStudentModal()">&times;</span>
                <h2 id="studentModalTitle">Student Details</h2>
            </div>
            <div class="modal-body" id="studentModalBody">
                <!-- Student details will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteStudent()">Delete Student</button>
                <button class="btn btn-secondary" onclick="editStudentSchedule()">‚úèÔ∏è Edit Schedule</button>
                <button class="btn btn-primary" onclick="closeStudentModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Apps Script Web App URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxOHs6TelVM347BqlaydmtiDaNSLeQwJkUCLRruP0HoHmTFSvrof-yA1q4A8wSKLqxt/exec';
        
        // Data storage
        let allStudents = [];
        let filteredStudents = [];
        let allOfferings = [];
        let filteredOfferings = [];
        let currentStudent = null;
        let currentOfferingId = null;

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data if needed
            if (tabName === 'students' && allStudents.length === 0) {
                loadStudents();
            } else if (tabName === 'offerings' && allOfferings.length === 0) {
                loadOfferings();
            }
        }

        // ==================== STUDENTS FUNCTIONS ====================

        async function loadStudents() {
            try {
                document.getElementById('studentsContainer').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading students...</p></div>';
                
                const response = await fetch(`${APPS_SCRIPT_URL}?action=loadAll`);
                const result = await response.json();
                
                if (result.success && result.students) {
                    allStudents = result.students;
                    filteredStudents = [...allStudents];
                    renderStudentsTable();
                    updateStudentStats();
                    showStatus(`‚úÖ Loaded ${allStudents.length} students`, 'success');
                } else {
                    allStudents = [];
                    filteredStudents = [];
                    renderStudentsTable();
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showStatus('‚ùå Error loading students: ' + error.message, 'error');
                document.getElementById('studentsContainer').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error loading students</p></div>';
            }
        }

        function renderStudentsTable() {
            const container = document.getElementById('studentsContainer');
            
            if (filteredStudents.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><h3>No students found</h3></div>';
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th style="width: 100px;">Total Classes</th>
                            <th style="width: 180px;">Last Updated</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredStudents.forEach(student => {
                const date = student.timestamp ? new Date(student.timestamp).toLocaleDateString() : 'N/A';
                html += `
                    <tr>
                        <td><strong>${student.name}</strong></td>
                        <td>${student.totalClasses || 0}</td>
                        <td style="font-size: 12px;">${date}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="viewStudent('${student.name}')">View</button>
                                <button class="btn btn-primary btn-small" onclick="editStudent('${student.name}')">Edit</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateStudentStats() {
            document.getElementById('totalStudents').textContent = allStudents.length;
            
            const totalEnrollments = allStudents.reduce((sum, s) => sum + (s.totalClasses || 0), 0);
            document.getElementById('totalEnrollments').textContent = totalEnrollments;
            
            const avg = allStudents.length > 0 ? Math.round(totalEnrollments / allStudents.length) : 0;
            document.getElementById('avgClasses').textContent = avg;
        }

        function filterStudents() {
            const search = document.getElementById('searchStudents').value.toLowerCase();
            filteredStudents = allStudents.filter(s => s.name.toLowerCase().includes(search));
            renderStudentsTable();
        }

        function viewStudent(studentName) {
            const student = allStudents.find(s => s.name === studentName);
            if (!student) return;
            
            currentStudent = student;
            document.getElementById('studentModalTitle').textContent = `${studentName}'s Schedule`;
            
            let classes = [];
            try {
                classes = JSON.parse(student.classes || '[]');
            } catch (e) {
                console.error('Error parsing classes:', e);
            }
            
            let html = `
                <div class="student-detail">
                    <p><strong>Name:</strong> ${studentName}</p>
                    <p><strong>Total Classes:</strong> ${student.totalClasses || 0}</p>
                    <p><strong>Last Updated:</strong> ${student.timestamp ? new Date(student.timestamp).toLocaleString() : 'N/A'}</p>
                </div>
                <h3>Selected Classes:</h3>
                <div class="class-list">
            `;
            
            if (classes.length === 0) {
                html += '<p style="color: #999; text-align: center;">No classes selected</p>';
            } else {
                classes.forEach(cls => {
                    const dayName = cls.day.charAt(0).toUpperCase() + cls.day.slice(1);
                    html += `
                        <div class="class-item">
                            <strong>${cls.name || cls.offeringName}</strong><br>
                            <span style="font-size: 12px; color: #666;">
                                üë§ ${cls.instructor} | üìÖ ${dayName} | ‚è∞ ${cls.time}
                            </span>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('studentModalBody').innerHTML = html;
            
            // Restore normal modal footer
            document.querySelector('#studentModal .modal-footer').innerHTML = `
                <button class="btn btn-danger" onclick="deleteStudent()">Delete Student</button>
                <button class="btn btn-secondary" onclick="editStudentSchedule()">‚úèÔ∏è Edit Schedule</button>
                <button class="btn btn-primary" onclick="closeStudentModal()">Close</button>
            `;
            
            document.getElementById('studentModal').style.display = 'block';
        }

        function editStudent(studentName) {
            window.open(`schedule_v2.html?student=${encodeURIComponent(studentName)}`, '_blank');
        }

        function editStudentSchedule() {
            if (currentStudent) {
                window.open(`schedule_v2.html?student=${encodeURIComponent(currentStudent.name)}`, '_blank');
            }
        }

        async function deleteStudent() {
            if (!currentStudent) return;
            
            if (confirm(`Are you sure you want to delete ${currentStudent.name}'s schedule?`)) {
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'delete',
                            studentName: currentStudent.name
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showStatus('‚úÖ Student deleted successfully', 'success');
                        closeStudentModal();
                        loadStudents();
                    } else {
                        showStatus('‚ùå Error: ' + result.message, 'error');
                    }
                } catch (error) {
                    showStatus('‚ùå Error deleting student: ' + error.message, 'error');
                }
            }
        }

        function closeStudentModal() {
            document.getElementById('studentModal').style.display = 'none';
            currentStudent = null;
        }

        // ==================== OFFERINGS FUNCTIONS ====================

        async function loadOfferings() {
            try {
                // Load students first if not already loaded (needed for enrollment counts)
                if (allStudents.length === 0) {
                    await loadStudents();
                }
                
                document.getElementById('offeringsContainer').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading offerings...</p></div>';
                
                const response = await fetch(`${APPS_SCRIPT_URL}?action=loadOfferings`);
                const result = await response.json();
                
                if (result.success && result.offerings) {
                    allOfferings = result.offerings;
                    filteredOfferings = [...allOfferings];
                    renderOfferingsTable();
                    updateOfferingsStats();
                    showStatus(`‚úÖ Loaded ${allOfferings.length} offerings`, 'success');
                } else {
                    allOfferings = [];
                    filteredOfferings = [];
                    renderOfferingsTable();
                    showStatus('üìö No offerings found. Add your first offering!', 'success');
                }
            } catch (error) {
                console.error('Error loading offerings:', error);
                showStatus('‚ùå Error loading offerings: ' + error.message, 'error');
                document.getElementById('offeringsContainer').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error loading offerings</p></div>';
            }
        }

        // Get students enrolled in a specific offering
        function getEnrolledStudents(offering) {
            const enrolled = [];
            
            allStudents.forEach(student => {
                try {
                    const classes = JSON.parse(student.classes || '[]');
                    const isEnrolled = classes.some(cls => {
                        const className = cls.name || cls.offeringName;
                        return className === offering.name && 
                               cls.day === offering.day && 
                               cls.time === offering.time;
                    });
                    
                    if (isEnrolled) {
                        enrolled.push(student.name);
                    }
                } catch (e) {
                    console.error('Error parsing student classes:', e);
                }
            });
            
            return enrolled;
        }

        // View enrollment modal
        function viewEnrollment(offeringId) {
            const offering = allOfferings.find(o => o.id === offeringId);
            if (!offering) return;
            
            const enrolledStudents = getEnrolledStudents(offering);
            const dayName = offering.day.charAt(0).toUpperCase() + offering.day.slice(1);
            
            document.getElementById('studentModalTitle').textContent = `Enrollment: ${offering.name}`;
            
            let html = `
                <div class="student-detail">
                    <p><strong>Class:</strong> ${offering.name}</p>
                    <p><strong>Instructor:</strong> ${offering.instructor}</p>
                    <p><strong>When:</strong> ${dayName}, ${offering.time}</p>
                    <p><strong>Type:</strong> <span class="type-badge type-${offering.type}">${offering.type}</span></p>
                    <p><strong>Total Enrolled:</strong> ${enrolledStudents.length} students</p>
                </div>
                <h3>Enrolled Students:</h3>
                <div class="class-list">
            `;
            
            if (enrolledStudents.length === 0) {
                html += '<p style="color: #999; text-align: center; padding: 20px;">No students enrolled yet</p>';
            } else {
                enrolledStudents.sort().forEach(studentName => {
                    html += `
                        <div class="class-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span><strong>${studentName}</strong></span>
                            <button class="btn btn-secondary btn-small" onclick="viewStudentFromEnrollment('${studentName}')">
                                View Schedule
                            </button>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('studentModalBody').innerHTML = html;
            
            // Hide delete button, show close only
            document.querySelector('#studentModal .modal-footer').innerHTML = `
                <button class="btn btn-primary" onclick="closeStudentModal()">Close</button>
            `;
            
            document.getElementById('studentModal').style.display = 'block';
        }

        function viewStudentFromEnrollment(studentName) {
            closeStudentModal();
            // Switch to students tab
            document.getElementById('offerings').classList.remove('active');
            document.getElementById('students').classList.add('active');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab')[0].classList.add('active');
            
            // View the student
            setTimeout(() => {
                viewStudent(studentName);
            }, 100);
        }

        function renderOfferingsTable() {
            const container = document.getElementById('offeringsContainer');
            
            if (filteredOfferings.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìö</div><h3>No offerings found</h3><p>Add your first offering to get started!</p></div>';
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 250px;">Offering Name</th>
                            <th style="width: 120px;">Instructor</th>
                            <th style="width: 80px;">Day</th>
                            <th style="width: 100px;">Time</th>
                            <th style="width: 80px;">Type</th>
                            <th style="width: 80px;">Enrolled</th>
                            <th style="width: 60px;">Loc</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredOfferings.forEach(offering => {
                const dayName = offering.day.charAt(0).toUpperCase() + offering.day.slice(1);
                const enrolledStudents = getEnrolledStudents(offering);
                const enrollmentCount = enrolledStudents.length;
                
                html += `
                    <tr>
                        <td><strong>${offering.name}</strong></td>
                        <td>${offering.instructor}</td>
                        <td>${dayName}</td>
                        <td style="font-size: 11px;">${offering.time}</td>
                        <td><span class="type-badge type-${offering.type}">${offering.type}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="viewEnrollment(${offering.id})" 
                                    style="background: ${enrollmentCount > 0 ? '#4CAF50' : '#999'};">
                                ${enrollmentCount} üë•
                            </button>
                        </td>
                        <td>${offering.location || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="editOffering(${offering.id})">Edit</button>
                                <button class="btn btn-danger btn-small" onclick="deleteOffering(${offering.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateOfferingsStats() {
            document.getElementById('totalOfferings').textContent = allOfferings.length;
            
            const uniqueInstructors = new Set(allOfferings.map(o => o.instructor));
            document.getElementById('totalInstructors').textContent = uniqueInstructors.size;
            
            const commitmentCount = allOfferings.filter(o => o.type === 'commitment').length;
            document.getElementById('commitmentCount').textContent = commitmentCount;
            
            const dropInCount = allOfferings.filter(o => o.type === 'drop-in').length;
            document.getElementById('dropInCount').textContent = dropInCount;
        }

        function filterOfferings() {
            const search = document.getElementById('searchOfferings').value.toLowerCase();
            const day = document.getElementById('filterDay').value;
            const time = document.getElementById('filterTime').value;
            const type = document.getElementById('filterType').value;

            filteredOfferings = allOfferings.filter(offering => {
                const matchesSearch = !search || 
                    offering.name.toLowerCase().includes(search) ||
                    offering.instructor.toLowerCase().includes(search) ||
                    (offering.description && offering.description.toLowerCase().includes(search));
                
                const matchesDay = !day || offering.day === day;
                const matchesTime = !time || offering.time === time;
                const matchesType = !type || offering.type === type;

                return matchesSearch && matchesDay && matchesTime && matchesType;
            });

            renderOfferingsTable();
        }

        function showAddOfferingModal() {
            currentOfferingId = null;
            document.getElementById('offeringModalTitle').textContent = 'Add New Offering';
            document.getElementById('offeringForm').reset();
            document.getElementById('offeringId').value = '';
            
            // Clear all day checkboxes
            document.querySelectorAll('input[name="days"]').forEach(cb => cb.checked = false);
            
            // Clear all time block checkboxes
            document.querySelectorAll('input[name="timeBlocks"]').forEach(cb => cb.checked = false);
            
            // Clear instructor multi-select
            const instructorSelect = document.getElementById('instructor');
            Array.from(instructorSelect.options).forEach(opt => opt.selected = false);
            
            // Clear level multi-select
            const levelSelect = document.getElementById('level');
            Array.from(levelSelect.options).forEach(opt => opt.selected = false);
            
            document.getElementById('offeringModal').style.display = 'block';
        }

        function editOffering(id) {
            const offering = allOfferings.find(o => o.id === id);
            if (!offering) return;

            currentOfferingId = id;
            document.getElementById('offeringModalTitle').textContent = 'Edit Offering';
            document.getElementById('offeringId').value = id;
            document.getElementById('offeringName').value = offering.name;
            
            // Handle instructors - split by ' & ' and select all
            const instructors = offering.instructor.split(' & ');
            const instructorSelect = document.getElementById('instructor');
            Array.from(instructorSelect.options).forEach(opt => {
                opt.selected = instructors.includes(opt.value);
            });
            
            document.getElementById('location').value = offering.location || '';
            
            // Handle days - check if this offering exists on multiple days
            const relatedOfferings = allOfferings.filter(o => 
                o.name === offering.name && 
                o.instructor === offering.instructor
            );
            
            // Get unique days
            const uniqueDays = [...new Set(relatedOfferings.map(o => o.day))];
            
            // Clear all day checkboxes first
            document.querySelectorAll('input[name="days"]').forEach(cb => cb.checked = false);
            
            // Check the appropriate days
            uniqueDays.forEach(day => {
                const checkbox = document.querySelector(`input[name="days"][value="${day}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            // Handle time blocks
            const uniqueTimes = [...new Set(relatedOfferings.map(o => o.time))];
            
            // Clear all time block checkboxes first
            document.querySelectorAll('input[name="timeBlocks"]').forEach(cb => cb.checked = false);
            
            // Check the appropriate time blocks
            uniqueTimes.forEach(time => {
                const checkbox = document.querySelector(`input[name="timeBlocks"][value="${time}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            document.getElementById('offeringType').value = offering.type;
            
            // Handle levels - split by ', ' and select all
            const levelSelect = document.getElementById('level');
            if (offering.level) {
                const levels = offering.level.split(', ');
                Array.from(levelSelect.options).forEach(opt => {
                    opt.selected = levels.includes(opt.value);
                });
            } else {
                Array.from(levelSelect.options).forEach(opt => opt.selected = false);
            }
            
            document.getElementById('description').value = offering.description || '';
            
            document.getElementById('offeringModal').style.display = 'block';
        }

        async function saveOffering() {
            const form = document.getElementById('offeringForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get selected days
            const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked'))
                .map(cb => cb.value);
            
            if (selectedDays.length === 0) {
                showStatus('‚ö†Ô∏è Please select at least one day', 'warning');
                return;
            }

            // Get selected time blocks
            const selectedTimeBlocks = Array.from(document.querySelectorAll('input[name="timeBlocks"]:checked'))
                .map(cb => cb.value);
            
            if (selectedTimeBlocks.length === 0) {
                showStatus('‚ö†Ô∏è Please select at least one time block', 'warning');
                return;
            }

            // Get selected instructors
            const instructorSelect = document.getElementById('instructor');
            const selectedInstructors = Array.from(instructorSelect.selectedOptions).map(opt => opt.value);
            
            if (selectedInstructors.length === 0) {
                showStatus('‚ö†Ô∏è Please select at least one facilitator', 'warning');
                return;
            }
            
            // Get selected levels
            const levelSelect = document.getElementById('level');
            const selectedLevels = Array.from(levelSelect.selectedOptions).map(opt => opt.value);
            const levelString = selectedLevels.length > 0 ? selectedLevels.join(', ') : '';

            const baseOfferingData = {
                name: document.getElementById('offeringName').value,
                instructor: selectedInstructors.join(' & '),  // Join multiple instructors
                location: document.getElementById('location').value,
                type: document.getElementById('offeringType').value,
                level: levelString,
                description: document.getElementById('description').value
            };

            try {
                if (currentOfferingId) {
                    // UPDATE EXISTING: Delete all related offerings, then recreate
                    const offering = allOfferings.find(o => o.id === currentOfferingId);
                    if (offering) {
                        // Find all related offerings (same name, instructor)
                        const relatedOfferings = allOfferings.filter(o => 
                            o.name === offering.name && 
                            o.instructor === offering.instructor
                        );
                        
                        // Delete all related offerings
                        for (const related of relatedOfferings) {
                            await fetch(APPS_SCRIPT_URL, {
                                method: 'POST',
                                body: JSON.stringify({
                                    action: 'deleteOffering',
                                    offeringId: related.id
                                })
                            });
                        }
                    }
                }
                
                // Create offering for each combination of day and time block
                let totalCreated = 0;
                for (const day of selectedDays) {
                    for (const timeBlock of selectedTimeBlocks) {
                        const offeringData = {
                            ...baseOfferingData,
                            day: day,
                            time: timeBlock,
                            action: 'saveOffering'
                        };
                        
                        const response = await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify(offeringData)
                        });
                        
                        const result = await response.json();
                        if (!result.success) {
                            showStatus('‚ùå Error: ' + result.message, 'error');
                            return;
                        }
                        totalCreated++;
                    }
                }

                const message = currentOfferingId ? '‚úÖ Offering updated!' : '‚úÖ Offering added!';
                const detailsText = ` (${selectedDays.length} days √ó ${selectedTimeBlocks.length} blocks = ${totalCreated} entries)`;
                showStatus(message + detailsText, 'success');
                
                closeOfferingModal();
                await loadOfferings();
                
            } catch (error) {
                showStatus('‚ùå Error saving: ' + error.message, 'error');
            }
        }

        async function deleteOffering(id) {
            const offering = allOfferings.find(o => o.id === id);
            if (!offering) return;

            // Find all related offerings (same name, instructor - across all days and times)
            const relatedOfferings = allOfferings.filter(o => 
                o.name === offering.name && 
                o.instructor === offering.instructor
            );

            const uniqueDays = [...new Set(relatedOfferings.map(o => o.day))];
            const uniqueBlocks = [...new Set(relatedOfferings.map(o => o.time))];
            
            let detailsText = '';
            if (uniqueDays.length > 1 || uniqueBlocks.length > 1) {
                detailsText = ` (${uniqueDays.length} days √ó ${uniqueBlocks.length} blocks = ${relatedOfferings.length} entries)`;
            }
            
            if (confirm(`Delete "${offering.name}"${detailsText}?`)) {
                try {
                    // Delete all related offerings
                    for (const related of relatedOfferings) {
                        const response = await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'deleteOffering',
                                offeringId: related.id
                            })
                        });
                        
                        const result = await response.json();
                        if (!result.success) {
                            showStatus('‚ùå Error: ' + result.message, 'error');
                            return;
                        }
                    }
                    
                    showStatus('‚úÖ Offering deleted!', 'success');
                    await loadOfferings();
                } catch (error) {
                    showStatus('‚ùå Error deleting: ' + error.message, 'error');
                }
            }
        }

        function closeOfferingModal() {
            document.getElementById('offeringModal').style.display = 'none';
            currentOfferingId = null;
        }

        // ==================== UTILITY FUNCTIONS ====================

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.getElementById('searchStudents').addEventListener('input', filterStudents);
        document.getElementById('searchOfferings').addEventListener('input', filterOfferings);
        document.getElementById('filterDay').addEventListener('change', filterOfferings);
        document.getElementById('filterTime').addEventListener('change', filterOfferings);
        document.getElementById('filterType').addEventListener('change', filterOfferings);

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize - load students first
        window.onload = function() {
            loadStudents();
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canopy Admin - Enhanced</title>
<style>
*{box-sizing:border-box}body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}
.container{max-width:1600px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h1{text-align:center;color:#2196F3;margin-bottom:5px}h2{font-size:16px;color:#666;text-align:center;margin:0 0 20px}
.tabs{display:flex;border-bottom:2px solid #ddd;margin-bottom:20px;gap:5px}
.tab{padding:12px 20px;cursor:pointer;background:#f0f0f0;border:none;border-bottom:3px solid transparent;font-size:15px;border-radius:8px 8px 0 0}
.tab:hover{background:#e0e0e0}.tab.active{background:white;border-bottom:3px solid #2196F3;color:#2196F3;font-weight:bold}
.tab-content{display:none}.tab-content.active{display:block}
.status{padding:12px;margin-bottom:20px;border-radius:4px;text-align:center;display:none}
.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:8px;text-align:center}
.stat-card h3{margin:0;font-size:32px}.stat-card p{margin:5px 0 0;font-size:13px;opacity:0.9}
.stat-card.orange{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
.actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px}
.btn{padding:10px 20px;font-size:14px;cursor:pointer;border:none;border-radius:4px;font-weight:600}
.btn-primary{background:#4CAF50;color:white}.btn-primary:hover{background:#45a049}
.btn-secondary{background:#2196F3;color:white}.btn-secondary:hover{background:#0b7dda}
.btn-danger{background:#f44336;color:white}.btn-danger:hover{background:#da190b}
.btn-success{background:#4CAF50;color:white}.btn-success:hover{background:#45a049}
.btn-warning{background:#ff9800;color:white}.btn-warning:hover{background:#e68900}
.btn-small{padding:6px 12px;font-size:12px;margin:2px}
table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
th{background:#4CAF50;color:white;padding:12px 8px;text-align:left;font-weight:bold;position:sticky;top:0}
td{padding:10px 8px;border:1px solid #ddd;vertical-align:top}
tr:nth-child(even){background:#f9f9f9}tr:hover{background:#e3f2fd}
.badge{display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;text-transform:uppercase}
.badge-pending{background:#fff3cd;color:#856404;border:1px solid #ffc107}
.loading{text-align:center;padding:40px;color:#999}.spinner{border:4px solid #f3f3f3;border-top:4px solid #4CAF50;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:#999;font-size:48px}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.5)}
.modal-content{background:white;margin:2% auto;padding:0;border-radius:8px;width:90%;max-width:600px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;background:#4CAF50;color:white;border-radius:8px 8px 0 0}.modal-header h2{margin:0;color:white;text-align:left}
.modal-body{padding:20px}.modal-footer{padding:15px 20px;background:#f8f9fa;border-radius:0 0 8px 8px;display:flex;justify-content:flex-end;gap:10px}
.close{color:white;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close:hover{opacity:0.8}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#333}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px}
.form-group textarea{resize:vertical;min-height:80px}
.request-card{background:white;border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
.request-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid #eee}
.request-student{font-size:18px;font-weight:bold;color:#2196F3}
.class-row{background:#f8f9fa;padding:10px;margin:5px 0;border-radius:4px;display:flex;justify-content:space-between;align-items:center;border-left:3px solid #2196F3}
.class-info{flex:1}
.class-name{font-weight:bold;color:#333;font-size:14px}
.class-details{font-size:12px;color:#666;margin-top:3px}
.class-actions{display:flex;gap:5px}
.group-actions{margin-top:10px;padding-top:10px;border-top:1px solid #ddd;display:flex;gap:10px;justify-content:flex-end}
.editable-cell{cursor:pointer;position:relative;padding:8px;border-radius:4px}
.editable-cell:hover{background:#e3f2fd}
.edit-icon{font-size:10px;color:#999;margin-left:5px}
input.inline-edit{padding:6px;font-size:13px;border:2px solid #2196F3;border-radius:4px;width:100%}
@media (max-width:768px){.actions{flex-direction:column}.stats{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="container">
<h1>üéì Canopy Admin - Enhanced</h1>
<h2>Session 3 (2025-2026) - Edit Offerings & Manual Enrollment</h2>
<div id="status" class="status"></div>
<div class="tabs">
<button class="tab active" onclick="switchTab(0)">‚è≥ Pending Requests</button>
<button class="tab" onclick="switchTab(1)">üë• Students</button>
<button class="tab" onclick="switchTab(2)">üìö Offerings</button>
</div>

<!-- PENDING REQUESTS TAB -->
<div id="pending" class="tab-content active">
<div class="stats">
<div class="stat-card orange"><h3 id="totalPending">0</h3><p>Pending Classes</p></div>
<div class="stat-card"><h3 id="totalStudentsWaiting">0</h3><p>Students Waiting</p></div>
</div>
<div class="actions">
<button class="btn btn-secondary" onclick="loadPendingRequests()">üîÑ Refresh</button>
</div>
<div id="pendingContainer"><div class="loading"><div class="spinner"></div>Loading...</div></div>
</div>

<!-- STUDENTS TAB -->
<div id="students" class="tab-content">
<div class="stats">
<div class="stat-card"><h3 id="totalStudents">0</h3><p>Approved Students</p></div>
<div class="stat-card orange"><h3 id="totalEnrollments">0</h3><p>Total Enrollments</p></div>
</div>
<div class="actions">
<button class="btn btn-secondary" onclick="loadStudents()">üîÑ Refresh</button>
</div>
<div id="studentsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>

<!-- OFFERINGS TAB -->
<div id="offerings" class="tab-content">
<div class="stats">
<div class="stat-card"><h3 id="totalOfferings">0</h3><p>Offerings</p></div>
<div class="stat-card orange"><h3 id="totalInstructors">0</h3><p>Instructors</p></div>
</div>
<div class="actions">
<button class="btn btn-primary" onclick="showCreateOfferingModal()">‚ûï Create New Offering</button>
<button class="btn btn-secondary" onclick="loadOfferings()">üîÑ Refresh</button>
</div>
<div id="offeringsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>
</div>

<!-- EDIT OFFERING MODAL -->
<div id="editModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeEditModal()">&times;</span>
<h2 id="editModalTitle">Edit Offering</h2>
</div>
<div class="modal-body">
<div class="form-group">
<label>Class Name *</label>
<input type="text" id="editName" placeholder="Math(A)" required>
</div>
<div class="form-group">
<label>Instructor/Facilitator *</label>
<input type="text" id="editInstructor" placeholder="Anna" required>
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="editLocation" placeholder="Room 101">
</div>
<div class="form-group">
<label>Day *</label>
<select id="editDay" required>
<option value="monday">Monday</option>
<option value="tuesday">Tuesday</option>
<option value="wednesday">Wednesday</option>
<option value="thursday">Thursday</option>
<option value="friday">Friday</option>
</select>
</div>
<div class="form-group">
<label>Time *</label>
<input type="text" id="editTime" placeholder="10:00-10:45" required>
</div>
<div class="form-group">
<label>Type *</label>
<select id="editType" required>
<option value="commitment">Commitment</option>
<option value="drop-in">Drop-in</option>
<option value="private">Private</option>
</select>
</div>
<div class="form-group">
<label>Level</label>
<select id="editLevel">
<option value="">All Levels</option>
<option value="acorns">Acorns</option>
<option value="canopy">Canopy</option>
<option value="canopy+">Canopy+</option>
<option value="mixed">Mixed Age</option>
</select>
</div>
<div class="form-group">
<label>Description</label>
<textarea id="editDescription" placeholder="Describe what students will learn and do in this class..." rows="4"></textarea>
</div>
<div class="form-group">
<label>Capacity *</label>
<input type="number" id="editCapacity" placeholder="12" min="1" required>
</div>
<p style="font-size:12px;color:#666;margin-top:10px">* Required fields</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
<button class="btn btn-primary" onclick="saveOffering()">üíæ Save Changes</button>
</div>
</div>
</div>

<!-- CREATE OFFERING MODAL -->
<div id="createModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeCreateModal()">&times;</span>
<h2>Create New Offering</h2>
</div>
<div class="modal-body">
<div class="form-group">
<label>Class Name *</label>
<input type="text" id="createName" placeholder="Math(A)" required>
</div>
<div class="form-group">
<label>Instructor/Facilitator *</label>
<input type="text" id="createInstructor" placeholder="Anna" required>
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="createLocation" placeholder="Room 101">
</div>
<div class="form-group">
<label>Days * (Hold Ctrl/Cmd to select multiple)</label>
<select id="createDays" multiple size="5" required style="height:auto">
<option value="monday">Monday</option>
<option value="tuesday">Tuesday</option>
<option value="wednesday">Wednesday</option>
<option value="thursday">Thursday</option>
<option value="friday">Friday</option>
</select>
<p style="font-size:11px;color:#666;margin-top:5px">üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple days</p>
</div>
<div class="form-group">
<label>Time Blocks * (Hold Ctrl/Cmd to select multiple)</label>
<select id="createBlocks" multiple size="6" required style="height:auto">
<option value="8:45-9:30">Block 1: 8:45-9:30</option>
<option value="10:00-10:45">Block 2: 10:00-10:45</option>
<option value="11:00-11:50">Block 3: 11:00-11:50</option>
<option value="1:00-1:50">Block 4: 1:00-1:50</option>
<option value="2:00-2:50">Block 5: 2:00-2:50</option>
<option value="3:00-3:50">Block 6: 3:00-3:50</option>
</select>
<p style="font-size:11px;color:#666;margin-top:5px">üí° Hold Ctrl (Windows) or Cmd (Mac) to select multiple blocks</p>
</div>
<div class="form-group">
<label>
<input type="checkbox" id="createMultiple" onchange="toggleMultipleCreation()">
Create separate offering for each day/block combination
</label>
<p style="font-size:11px;color:#666;margin-top:5px">
‚úì Checked: Creates individual offerings (e.g., Math(A) Mon 10:00, Math(A) Tue 10:00)<br>
‚úó Unchecked: Single offering with multiple times (e.g., Math(A) shows "Mon, Tue" and "10:00, 1:00")
</p>
</div>
<div class="form-group">
<label>Type *</label>
<select id="createType" required>
<option value="">-- Select Type --</option>
<option value="commitment">Commitment</option>
<option value="drop-in">Drop-in</option>
<option value="private">Private</option>
</select>
</div>
<div class="form-group">
<label>Level</label>
<select id="createLevel">
<option value="">All Levels</option>
<option value="acorns">Acorns</option>
<option value="canopy">Canopy</option>
<option value="canopy+">Canopy+</option>
<option value="mixed">Mixed Age</option>
</select>
</div>
<div class="form-group">
<label>Description</label>
<textarea id="createDescription" placeholder="Describe what students will learn and do in this class..." rows="4"></textarea>
</div>
<div class="form-group">
<label>Capacity *</label>
<input type="number" id="createCapacity" placeholder="12" min="1" value="12" required>
</div>
<p style="font-size:12px;color:#666;margin-top:10px">* Required fields</p>
<div id="createPreview" style="background:#f8f9fa;padding:15px;border-radius:4px;margin-top:15px;display:none">
<strong>Preview:</strong>
<div id="createPreviewText" style="margin-top:10px;font-size:13px"></div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
<button class="btn btn-primary" onclick="createOffering()">‚ûï Create Offering(s)</button>
</div>
</div>
</div>

<!-- ADD STUDENT TO CLASS MODAL -->
<div id="enrollModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeEnrollModal()">&times;</span>
<h2 id="enrollModalTitle">Add Student to Class</h2>
</div>
<div class="modal-body">
<p id="enrollClassName" style="font-size:16px;font-weight:bold;color:#2196F3;margin-bottom:15px"></p>
<div class="form-group">
<label>Select Student</label>
<select id="enrollStudent">
<option value="">-- Select Student --</option>
</select>
</div>
<p style="font-size:12px;color:#666;margin-top:10px">
This will add the class to the student's approved schedule.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEnrollModal()">Cancel</button>
<button class="btn btn-primary" onclick="addStudentToClass()">‚ûï Add Student</button>
</div>
</div>
</div>

<!-- ENROLLED STUDENTS MODAL -->
<div id="enrolledModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span class="close" onclick="closeEnrolledModal()">&times;</span>
<h2 id="enrolledModalTitle">Enrolled Students</h2>
</div>
<div class="modal-body">
<p id="enrolledClassName" style="font-size:18px;font-weight:bold;color:#2196F3;margin-bottom:15px"></p>
<div id="enrolledList"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEnrolledModal()">Close</button>
</div>
</div>
</div>

<script>
const API='https://script.google.com/macros/s/AKfycbwUV7DXx8J4p31M5jT5NjulaSdmWMpxdDWDogUEv4bFB2Gc5NcDGKSco9ytsmdxhNzu/exec';
let pending=[],students=[],offerings=[],allStudentNames=[];
let currentEditId=null,currentEnrollOfferingId=null;

function switchTab(i){
document.querySelectorAll('.tab-content,.tab').forEach(e=>e.classList.remove('active'));
document.querySelectorAll('.tab')[i].classList.add('active');
document.querySelectorAll('.tab-content')[i].classList.add('active');
if(i===0)loadPendingRequests();
if(i===1)loadStudents();
if(i===2)loadOfferings();
}

async function loadPendingRequests(){
try{
document.getElementById('pendingContainer').innerHTML='<div class="loading"><div class="spinner"></div>Loading...</div>';
const r=await fetch(`${API}?action=getPendingRequests`);
const d=await r.json();
pending=d.requests||[];
document.getElementById('totalPending').textContent=pending.length;
const uniqueStudents=new Set(pending.map(p=>p.studentName));
document.getElementById('totalStudentsWaiting').textContent=uniqueStudents.size;
renderPendingRequests();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderPendingRequests(){
const c=document.getElementById('pendingContainer');
if(!pending.length){c.innerHTML='<div class="empty">‚úÖ<br>No pending requests</div>';return}
const grouped={};
pending.forEach(p=>{
if(!grouped[p.studentName])grouped[p.studentName]=[];
grouped[p.studentName].push(p);
});
let html='';
Object.keys(grouped).forEach(studentName=>{
const requests=grouped[studentName];
const firstReq=requests[0];
const date=new Date(firstReq.submitted).toLocaleString();
const baseRequestId=firstReq.requestId.split('_')[0]+'_'+firstReq.requestId.split('_')[1];
html+=`<div class="request-card">
<div class="request-header">
<div><div class="request-student">${studentName}</div>
<div style="font-size:12px;color:#999">Submitted: ${date}</div></div>
<div><span class="badge badge-pending">PENDING</span></div>
</div>`;
requests.forEach(req=>{
html+=`<div class="class-row">
<div class="class-info">
<div class="class-name">${req.className}</div>
<div class="class-details">${req.dayTime}</div>
</div>
<div class="class-actions">
<button class="btn btn-success btn-small" onclick="approveClass('${req.requestId}','${req.offeringId}','${studentName}','${req.className}')">‚úì Approve</button>
<button class="btn btn-danger btn-small" onclick="denyClass('${req.requestId}','${req.offeringId}','${studentName}','${req.className}')">‚úó Deny</button>
</div>
</div>`;
});
html+=`<div class="group-actions">
<button class="btn btn-success btn-small" onclick="approveAllForStudent('${baseRequestId}','${studentName}')">‚úì Approve All (${requests.length})</button>
<button class="btn btn-danger btn-small" onclick="denyAllForStudent('${baseRequestId}','${studentName}')">‚úó Deny All</button>
</div></div>`;
});
c.innerHTML=html;
}

async function approveClass(requestId,offeringId,studentName,className){
if(!confirm(`Approve "${className}" for ${studentName}?`))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'approveClass',requestId:requestId,offeringId:offeringId})});
const d=await r.json();
if(d.success){msg(`‚úÖ Approved: ${className}`,'success');await loadPendingRequests();await loadStudents();}
else{msg('‚ùå '+d.message,'error');}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function denyClass(requestId,offeringId,studentName,className){
if(!confirm(`Deny "${className}" for ${studentName}?`))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'denyClass',requestId:requestId,offeringId:offeringId})});
const d=await r.json();
if(d.success){msg(`‚úÖ Denied: ${className}`,'success');await loadPendingRequests();}
else{msg('‚ùå '+d.message,'error');}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function approveAllForStudent(baseRequestId,studentName){
if(!confirm(`Approve ALL classes for ${studentName}?`))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'approveAllClasses',requestId:baseRequestId})});
const d=await r.json();
if(d.success){msg(`‚úÖ Approved ${d.count} class(es)`,'success');await loadPendingRequests();await loadStudents();}
else{msg('‚ùå '+d.message,'error');}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function denyAllForStudent(baseRequestId,studentName){
if(!confirm(`Deny ALL classes for ${studentName}?`))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'denyAllClasses',requestId:baseRequestId})});
const d=await r.json();
if(d.success){msg(`‚úÖ Denied ${d.count} class(es)`,'success');await loadPendingRequests();}
else{msg('‚ùå '+d.message,'error');}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function loadStudents(){
try{
document.getElementById('studentsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadAll`);
const d=await r.json();
students=d.students||[];
document.getElementById('totalStudents').textContent=students.length;
const total=students.reduce((s,st)=>s+(st.totalClasses||0),0);
document.getElementById('totalEnrollments').textContent=total;

// Load ALL students from Students sheet (master list)
const r2=await fetch(`${API}?action=getAllStudents`);
const d2=await r2.json();
if(d2.success){
allStudentNames=d2.students||[];
}else{
// Fallback to approved students if Students sheet doesn't exist
const r3=await fetch(`${API}?action=loadStudents`);
const d3=await r3.json();
allStudentNames=d3.students?d3.students.map(name=>({id:'',name:name})):[];
}

renderStudents();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderStudents(){
const c=document.getElementById('studentsContainer');
if(!students.length){c.innerHTML='<div class="empty">üë•<br>No approved students yet</div>';return}
let html='<table><thead><tr><th>Name</th><th>Classes</th><th>Updated</th></tr></thead><tbody>';
students.forEach(s=>{
const date=s.timestamp?new Date(s.timestamp).toLocaleDateString():'N/A';
html+=`<tr><td><strong>${s.name}</strong></td><td>${s.totalClasses||0}</td><td>${date}</td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

async function loadOfferings(){
try{
document.getElementById('offeringsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadOfferings`);
const d=await r.json();
offerings=d.offerings||[];
document.getElementById('totalOfferings').textContent=offerings.length;
const instructors=new Set(offerings.map(o=>o.instructor));
document.getElementById('totalInstructors').textContent=instructors.size;

// Also load students to calculate enrollment
const r2=await fetch(`${API}?action=loadAll`);
const d2=await r2.json();
students=d2.students||[];

renderOfferings();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function getEnrolledStudents(offeringId){
const enrolled=[];
students.forEach(s=>{
try{
const classes=JSON.parse(s.classes||'[]');
if(classes.includes(offeringId)){
enrolled.push(s.name);
}
}catch(e){}
});
return enrolled;
}

function renderOfferings(){
const c=document.getElementById('offeringsContainer');
if(!offerings.length){c.innerHTML='<div class="empty">üìö<br>No offerings</div>';return}
let html='<table><thead><tr><th>Name</th><th>Instructor</th><th>Day</th><th>Time</th><th>Type</th><th>Enrolled</th><th>Actions</th></tr></thead><tbody>';
offerings.forEach(o=>{
const day=o.day.charAt(0).toUpperCase()+o.day.slice(1);
const enrolled=getEnrolledStudents(o.id);
const capacity=o.capacity||999;
const enrolledCount=enrolled.length;
const isFull=enrolledCount>=capacity;
const enrolledBtn=enrolledCount>0?
`<button class="btn btn-secondary btn-small" onclick="showEnrolledModal(${o.id},'${o.name}')">${enrolledCount}/${capacity} üë•</button>`:
`<span style="color:#999">${enrolledCount}/${capacity}</span>`;

html+=`<tr style="${isFull?'background:#ffe6e6':''}">
<td><strong>${o.name}</strong></td>
<td class="editable-cell" onclick="quickEditInstructor(${o.id},'${o.instructor}')">${o.instructor} <span class="edit-icon">‚úèÔ∏è</span></td>
<td>${day}</td>
<td style="font-size:11px">${o.time}</td>
<td>${o.type}</td>
<td>${enrolledBtn}</td>
<td>
<button class="btn btn-warning btn-small" onclick="editOffering(${o.id})">‚úèÔ∏è Edit</button>
<button class="btn btn-primary btn-small" onclick="showEnrollModal(${o.id},'${o.name}')">‚ûï Add</button>
</td>
</tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

function quickEditInstructor(id,currentName){
const newName=prompt('Edit Instructor Name:',currentName);
if(newName&&newName!==currentName){
updateOfferingField(id,'instructor',newName);
}
}

async function updateOfferingField(id,field,value){
try{
const offering=offerings.find(o=>o.id===id);
if(!offering)return;
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'updateOffering',
offeringId:id,
name:offering.name,
instructor:field==='instructor'?value:offering.instructor,
location:offering.location,
day:offering.day,
time:offering.time,
type:offering.type,
level:offering.level,
description:offering.description,
capacity:offering.capacity
})});
const d=await r.json();
if(d.success){
msg('‚úÖ Updated instructor','success');
await loadOfferings();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

function editOffering(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
currentEditId=id;
document.getElementById('editModalTitle').textContent='Edit: '+o.name;
document.getElementById('editName').value=o.name;
document.getElementById('editInstructor').value=o.instructor;
document.getElementById('editLocation').value=o.location||'';
document.getElementById('editDay').value=o.day;
document.getElementById('editTime').value=o.time;
document.getElementById('editType').value=o.type;
document.getElementById('editLevel').value=o.level||'';
document.getElementById('editDescription').value=o.description||'';
document.getElementById('editCapacity').value=o.capacity||12;
document.getElementById('editModal').style.display='block';
}

function closeEditModal(){
document.getElementById('editModal').style.display='none';
currentEditId=null;
}

function showCreateOfferingModal(){
document.getElementById('createName').value='';
document.getElementById('createInstructor').value='';
document.getElementById('createLocation').value='';
document.getElementById('createDays').selectedIndex=-1;
document.getElementById('createBlocks').selectedIndex=-1;
document.getElementById('createMultiple').checked=false;
document.getElementById('createType').value='';
document.getElementById('createLevel').value='';
document.getElementById('createDescription').value='';
document.getElementById('createCapacity').value='12';
document.getElementById('createPreview').style.display='none';
document.getElementById('createModal').style.display='block';
}

function closeCreateModal(){
document.getElementById('createModal').style.display='none';
}

function toggleMultipleCreation(){
updateCreatePreview();
}

function updateCreatePreview(){
const daysSelect=document.getElementById('createDays');
const blocksSelect=document.getElementById('createBlocks');
const multiple=document.getElementById('createMultiple').checked;
const name=document.getElementById('createName').value.trim();

const selectedDays=Array.from(daysSelect.selectedOptions).map(o=>o.text);
const selectedBlocks=Array.from(blocksSelect.selectedOptions).map(o=>o.value);

if(selectedDays.length>0&&selectedBlocks.length>0){
const preview=document.getElementById('createPreview');
const previewText=document.getElementById('createPreviewText');
preview.style.display='block';

if(multiple){
const count=selectedDays.length*selectedBlocks.length;
previewText.innerHTML=`<strong>Will create ${count} separate offering(s):</strong><br>`;
selectedDays.forEach(day=>{
selectedBlocks.forEach(block=>{
previewText.innerHTML+=`‚Ä¢ ${name||'[Class]'} - ${day} ${block}<br>`;
});
});
}else{
previewText.innerHTML=`<strong>Will create 1 offering:</strong><br>`;
previewText.innerHTML+=`‚Ä¢ ${name||'[Class]'} - Days: ${selectedDays.join(', ')}<br>`;
previewText.innerHTML+=`‚Ä¢ Times: ${selectedBlocks.join(', ')}`;
}
}else{
document.getElementById('createPreview').style.display='none';
}
}

// Add event listeners for preview
document.addEventListener('DOMContentLoaded',()=>{
if(document.getElementById('createDays')){
document.getElementById('createDays').addEventListener('change',updateCreatePreview);
document.getElementById('createBlocks').addEventListener('change',updateCreatePreview);
document.getElementById('createName').addEventListener('input',updateCreatePreview);
}
});

async function createOffering(){
const name=document.getElementById('createName').value.trim();
const instructor=document.getElementById('createInstructor').value.trim();
const type=document.getElementById('createType').value;

const daysSelect=document.getElementById('createDays');
const blocksSelect=document.getElementById('createBlocks');
const selectedDays=Array.from(daysSelect.selectedOptions).map(o=>o.value);
const selectedBlocks=Array.from(blocksSelect.selectedOptions).map(o=>o.value);
const createMultiple=document.getElementById('createMultiple').checked;

if(!name||!instructor||selectedDays.length===0||selectedBlocks.length===0||!type){
alert('Please fill in all required fields:\n- Class Name\n- Instructor\n- At least one Day\n- At least one Time Block\n- Type');
return;
}

const baseData={
name:name,
instructor:instructor,
location:document.getElementById('createLocation').value.trim(),
type:type,
level:document.getElementById('createLevel').value,
description:document.getElementById('createDescription').value.trim(),
capacity:parseInt(document.getElementById('createCapacity').value)||12
};

try{
if(createMultiple){
// Create separate offering for each day/block combination
let created=0;
for(const day of selectedDays){
for(const block of selectedBlocks){
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'saveOffering',
...baseData,
day:day,
time:block
})});
const d=await r.json();
if(d.success)created++;
}
}
msg(`‚úÖ Created ${created} offering(s)!`,'success');
closeCreateModal();
await loadOfferings();
}else{
// Create single offering with multiple days/blocks
const days=selectedDays.join(',');
const times=selectedBlocks.join(',');
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'saveOffering',
...baseData,
day:days,
time:times
})});
const d=await r.json();
if(d.success){
msg(`‚úÖ Created: ${name}`,'success');
closeCreateModal();
await loadOfferings();
}else{
msg('‚ùå '+d.message,'error');
}
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function saveOffering(){
if(!currentEditId)return;
const o=offerings.find(of=>of.id===currentEditId);
if(!o)return;

const name=document.getElementById('editName').value.trim();
const instructor=document.getElementById('editInstructor').value.trim();
const day=document.getElementById('editDay').value;
const time=document.getElementById('editTime').value.trim();
const type=document.getElementById('editType').value;

if(!name||!instructor||!day||!time||!type){
alert('Please fill in all required fields (marked with *)');
return;
}

try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'updateOffering',
offeringId:currentEditId,
name:name,
instructor:instructor,
location:document.getElementById('editLocation').value.trim(),
day:day,
time:time,
type:type,
level:document.getElementById('editLevel').value,
description:document.getElementById('editDescription').value.trim(),
capacity:parseInt(document.getElementById('editCapacity').value)||12
})});
const d=await r.json();
if(d.success){
msg('‚úÖ Offering updated','success');
closeEditModal();
await loadOfferings();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

function showEnrollModal(offeringId,offeringName){
currentEnrollOfferingId=offeringId;
document.getElementById('enrollModalTitle').textContent='Add Student to Class';
document.getElementById('enrollClassName').textContent=offeringName;
const select=document.getElementById('enrollStudent');
select.innerHTML='<option value="">-- Select Student --</option>';

// Sort students by name
const sortedStudents=[...allStudentNames].sort((a,b)=>{
const nameA=a.name||a;
const nameB=b.name||b;
return nameA.localeCompare(nameB);
});

sortedStudents.forEach(student=>{
const name=student.name||student;
const id=student.id||'';
const grade=student.grade||'';
const level=student.level||'';
let displayText=name;
if(id)displayText+=` (ID: ${id})`;
if(grade)displayText+=` - Grade ${grade}`;
if(level)displayText+=` - ${level}`;
select.innerHTML+=`<option value="${name}" data-id="${id}">${displayText}</option>`;
});

document.getElementById('enrollModal').style.display='block';
}

function closeEnrollModal(){
document.getElementById('enrollModal').style.display='none';
currentEnrollOfferingId=null;
}

function showEnrolledModal(offeringId,offeringName){
const offering=offerings.find(o=>o.id===offeringId);
const enrolled=getEnrolledStudents(offeringId);
const capacity=offering?offering.capacity||999:999;

document.getElementById('enrolledModalTitle').textContent='Enrolled Students';
document.getElementById('enrolledClassName').textContent=offeringName;

let html='<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px">';
html+=`<p style="margin:0"><strong>Enrolled:</strong> ${enrolled.length} / ${capacity}</p>`;
if(enrolled.length>=capacity){
html+=`<p style="margin:5px 0 0;color:#d32f2f;font-weight:bold">‚ö†Ô∏è CLASS IS FULL</p>`;
}else{
html+=`<p style="margin:5px 0 0;color:#4CAF50">${capacity-enrolled.length} spot(s) remaining</p>`;
}
html+='</div>';

if(enrolled.length===0){
html+='<p style="text-align:center;color:#999;padding:40px 20px">No students enrolled yet</p>';
}else{
html+='<div style="max-height:400px;overflow-y:auto">';
enrolled.sort().forEach((name,index)=>{
html+=`<div style="background:white;padding:12px;margin:5px 0;border-radius:4px;border-left:3px solid #2196F3;display:flex;justify-content:space-between;align-items:center">
<div><strong>${index+1}. ${name}</strong></div>
<button class="btn btn-danger btn-small" onclick="removeStudentFromClass('${name}',${offeringId},'${offeringName}')">‚úó Remove</button>
</div>`;
});
html+='</div>';
}

document.getElementById('enrolledList').innerHTML=html;
document.getElementById('enrolledModal').style.display='block';
}

function closeEnrolledModal(){
document.getElementById('enrolledModal').style.display='none';
}

async function removeStudentFromClass(studentName,offeringId,className){
if(!confirm(`Remove ${studentName} from ${className}?`))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'removeEnrollment',
studentName:studentName,
offeringId:offeringId
})});
const d=await r.json();
if(d.success){
msg(`‚úÖ Removed ${studentName}`,'success');
await loadStudents();
await loadOfferings();
closeEnrolledModal();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function addStudentToClass(){
const studentName=document.getElementById('enrollStudent').value;
if(!studentName){
alert('Please select a student');
return;
}
if(!currentEnrollOfferingId)return;
if(!confirm(`Add ${studentName} to this class?`))return;
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'manualEnroll',
studentName:studentName,
offeringId:currentEnrollOfferingId
})});
const d=await r.json();
if(d.success){
msg(`‚úÖ Added ${studentName} to class`,'success');
closeEnrollModal();
await loadStudents();
}else{
msg('‚ùå '+d.message,'error');
}
}catch(e){msg('‚ùå '+e.message,'error')}
}

function msg(text,type){
const s=document.getElementById('status');
s.textContent=text;
s.className='status '+type;
s.style.display='block';
setTimeout(()=>s.style.display='none',3000);
}

window.onclick=e=>{
if(e.target.classList.contains('modal'))e.target.style.display='none';
}

window.onload=()=>loadPendingRequests();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Canopy Admin</title>
<style>
*{box-sizing:border-box}body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f5f5f5}
.container{max-width:1600px;margin:0 auto;background:white;padding:20px;border-radius:8px}
h1{text-align:center;color:#2196F3;margin-bottom:5px}
.tabs{display:flex;border-bottom:2px solid #ddd;margin:20px 0;gap:5px}
.tab{padding:12px 24px;cursor:pointer;background:#f0f0f0;border:none;font-size:16px}
.tab.active{background:white;border-bottom:3px solid #2196F3;color:#2196F3;font-weight:bold}
.tab-content{display:none}.tab-content.active{display:block}
.status{padding:12px;margin-bottom:20px;border-radius:4px;text-align:center;display:none}
.status.success{background:#d4edda;color:#155724}.status.error{background:#f8d7da;color:#721c24}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:8px;text-align:center}
.stat-card h3{margin:0;font-size:32px}
.actions{display:flex;justify-content:space-between;margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;gap:10px;flex-wrap:wrap}
.search{display:flex;gap:10px;flex:1;max-width:600px}.search input,.search select{padding:8px;border:2px solid #ddd;border-radius:4px}
.btn{padding:10px 20px;font-size:14px;cursor:pointer;border:none;border-radius:4px;font-weight:600}
.btn-primary{background:#4CAF50;color:white}.btn-secondary{background:#2196F3;color:white}.btn-danger{background:#f44336;color:white}
.btn-small{padding:6px 12px;font-size:12px}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#4CAF50;color:white;padding:12px 8px;text-align:left}
td{padding:10px 8px;border:1px solid #ddd}
tr:nth-child(even){background:#f9f9f9}
.badge{display:inline-block;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold}
.badge-commitment{background:#ffcdd2;color:#c62828}.badge-drop-in{background:#c8e6c9;color:#2e7d32}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}
.modal-content{background:white;margin:2% auto;padding:0;border-radius:8px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto}
.modal-header{padding:20px;background:#4CAF50;color:white;border-radius:8px 8px 0 0}
.modal-body{padding:20px}.modal-footer{padding:15px 20px;background:#f8f9fa;display:flex;justify-content:flex-end;gap:10px}
.close{color:white;float:right;font-size:28px;cursor:pointer}
.form-group{margin-bottom:15px}.form-group label{display:block;margin-bottom:5px;font-weight:bold}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:4px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.loading{text-align:center;padding:40px}.spinner{border:4px solid #f3f3f3;border-top:4px solid #4CAF50;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{100%{transform:rotate(360deg)}}
.detail{background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px}
.class-item{background:white;padding:8px;margin:5px 0;border-radius:4px;border-left:3px solid #2196F3}
.student-check{padding:8px;background:white;margin:5px 0;border-radius:4px;border-left:3px solid #2196F3}
.student-check input{margin-right:8px}
.schedule-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px}
.day-col{background:#f8f9fa;padding:10px;border-radius:4px}
.day-col h4{margin:0 0 10px;font-size:12px;text-align:center}
.time-slot{margin-bottom:10px}
.time-slot label{display:block;font-size:11px;margin-bottom:3px}
.time-slot select{width:100%;padding:6px;font-size:11px}
@media(max-width:768px){.schedule-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<h1>üéì Canopy Admin</h1>
<div id="status" class="status"></div>
<div class="tabs">
<button class="tab active" onclick="switchTab(0)">üë• Students</button>
<button class="tab" onclick="switchTab(1)">üìö Offerings</button>
</div>
<div id="students" class="tab-content active">
<div class="stats">
<div class="stat-card"><h3 id="totalStudents">0</h3><p>Students</p></div>
<div class="stat-card"><h3 id="totalEnrollments">0</h3><p>Enrollments</p></div>
</div>
<div class="actions">
<div class="search"><input type="text" id="searchStudents" placeholder="Search..." oninput="renderStudents()"></div>
<button class="btn btn-secondary" onclick="loadStudents()">üîÑ</button>
</div>
<div id="studentsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>
<div id="offerings" class="tab-content">
<div class="stats">
<div class="stat-card"><h3 id="totalOfferings">0</h3><p>Offerings</p></div>
<div class="stat-card"><h3 id="totalInstructors">0</h3><p>Instructors</p></div>
</div>
<div class="actions">
<div class="search">
<input type="text" id="searchOfferings" placeholder="Search..." oninput="renderOfferings()">
<select id="filterDay" onchange="renderOfferings()"><option value="">All Days</option><option value="monday">Mon</option><option value="tuesday">Tue</option><option value="wednesday">Wed</option><option value="thursday">Thu</option><option value="friday">Fri</option></select>
</div>
<button class="btn btn-secondary" onclick="loadOfferings()">üîÑ</button>
<button class="btn btn-primary" onclick="showAddModal()">+ Add</button>
</div>
<div id="offeringsContainer"><div class="loading"><div class="spinner"></div></div></div>
</div>
</div>
<div id="offeringModal" class="modal"><div class="modal-content"><div class="modal-header"><span class="close" onclick="closeModal()">&times;</span><h2 id="modalTitle">Add</h2></div><div class="modal-body"><form id="form"><div class="form-group"><label>Name</label><input id="name" required></div><div class="form-row"><div class="form-group"><label>Facilitators</label><select id="instructor" multiple size="5" required><option>Amber</option><option>Anna</option><option>Ashlyn</option><option>Doug</option><option>Elliott</option><option>Geoff</option><option>Grace</option><option>Jamie</option><option>Jenique</option><option>Lacy</option><option>Nancy</option><option>Penny</option><option>Tiff</option><option>Travis</option></select></div><div class="form-group"><label>Location</label><input id="location"></div></div><div class="form-row"><div class="form-group"><label>Days</label><div style="padding:10px;border:2px solid #ddd"><label><input type="checkbox" name="days" value="monday"> Mon</label><br><label><input type="checkbox" name="days" value="tuesday"> Tue</label><br><label><input type="checkbox" name="days" value="wednesday"> Wed</label><br><label><input type="checkbox" name="days" value="thursday"> Thu</label><br><label><input type="checkbox" name="days" value="friday"> Fri</label></div></div><div class="form-group"><label>Times</label><div style="padding:10px;border:2px solid #ddd;max-height:180px;overflow-y:auto"><label><input type="checkbox" name="times" value="10:00-10:45"> Block 1</label><br><label><input type="checkbox" name="times" value="10:50-11:35"> Block 2</label><br><label><input type="checkbox" name="times" value="11:35-12:05"> Lunch</label><br><label><input type="checkbox" name="times" value="12:10-12:55"> Block 3</label><br><label><input type="checkbox" name="times" value="1:00-1:50"> Block 4</label><br><label><input type="checkbox" name="times" value="1:55-2:45"> Block 5</label></div></div></div><div class="form-row"><div class="form-group"><label>Type</label><select id="type" required><option value="">Select</option><option value="commitment">Commitment</option><option value="drop-in">Drop-in</option><option value="private">Private</option></select></div><div class="form-group"><label>Levels</label><select id="level" multiple size="4"><option>All</option><option>EC</option><option>Saplings</option><option>Acorns</option><option>Canopy</option></select></div></div><div class="form-group"><label>Capacity</label><input type="number" id="capacity" min="1"></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="save()">Save</button></div></div></div>
<div id="detailModal" class="modal"><div class="modal-content"><div class="modal-header"><span class="close" onclick="closeDetail()">&times;</span><h2 id="detailTitle"></h2></div><div class="modal-body" id="detailBody"></div><div class="modal-footer" id="detailFooter"></div></div></div>
<script>
const API='https://script.google.com/macros/s/AKfycbxOHs6TelVM347BqlaydmtiDaNSLeQwJkUCLRruP0HoHmTFSvrof-yA1q4A8wSKLqxt/exec';
const DAYS=['monday','tuesday','wednesday','thursday','friday'];
const TIMES=['10:00-10:45','10:50-11:35','11:35-12:05','12:10-12:55','1:00-1:50','1:55-2:45'];
const LABELS=['Block 1','Block 2','Lunch','Block 3','Block 4','Block 5'];
let students=[],offerings=[],currentEdit=null,editingStudent=null;

function switchTab(i){
document.querySelectorAll('.tab-content,.tab').forEach(e=>e.classList.remove('active'));
document.querySelectorAll('.tab')[i].classList.add('active');
document.querySelectorAll('.tab-content')[i].classList.add('active');
if(i===0&&!students.length)loadStudents();
if(i===1&&!offerings.length)loadOfferings();
}

async function loadStudents(){
try{
document.getElementById('studentsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadAll`);
const d=await r.json();
students=d.students||[];
document.getElementById('totalStudents').textContent=students.length;
const total=students.reduce((s,st)=>s+(st.totalClasses||0),0);
document.getElementById('totalEnrollments').textContent=total;
renderStudents();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderStudents(){
const c=document.getElementById('studentsContainer');
const search=document.getElementById('searchStudents').value.toLowerCase();
const filtered=students.filter(s=>s.name.toLowerCase().includes(search));
if(!filtered.length){c.innerHTML='<p style="text-align:center;padding:40px">No students</p>';return}
let html='<table><thead><tr><th>Name</th><th style="width:100px">Classes</th><th style="width:150px">Actions</th></tr></thead><tbody>';
filtered.forEach(s=>{
html+=`<tr><td><strong>${s.name}</strong></td><td>${s.totalClasses||0}</td>
<td><button class="btn btn-secondary btn-small" onclick="viewStudent('${s.name}')">View</button>
<button class="btn btn-primary btn-small" onclick="editStudentSchedule('${s.name}')">Edit</button></td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

function viewStudent(name){
const s=students.find(st=>st.name===name);
if(!s)return;
let classes=[];
try{classes=JSON.parse(s.classes||'[]')}catch(e){}
let html=`<div class="detail"><p><strong>${name}</strong> - ${s.totalClasses||0} classes</p></div>`;
if(!classes.length){html+='<p style="text-align:center;color:#999">No classes</p>'}
else{classes.forEach(c=>{
html+=`<div class="class-item"><strong>${c.name||c.offeringName}</strong><br>
<small>${c.instructor} | ${c.day} | ${c.time}</small></div>`;
})}
document.getElementById('detailTitle').textContent=name;
document.getElementById('detailBody').innerHTML=html;
document.getElementById('detailFooter').innerHTML='<button class="btn btn-primary btn-small" onclick="editStudentSchedule(\''+name+'\')">Edit</button><button class="btn btn-secondary" onclick="closeDetail()">Close</button>';
document.getElementById('detailModal').style.display='block';
}

async function editStudentSchedule(name){
editingStudent=name;
const s=students.find(st=>st.name===name);
let currentClasses=[];
try{currentClasses=JSON.parse(s?.classes||'[]')}catch(e){}
let html='<div class="schedule-grid">';
DAYS.forEach((day,di)=>{
html+=`<div class="day-col"><h4>${day.toUpperCase().slice(0,3)}</h4>`;
TIMES.forEach((time,ti)=>{
const current=currentClasses.find(c=>c.day===day&&c.time===time);
const opts=offerings.filter(o=>o.day===day&&o.time===time);
html+=`<div class="time-slot"><label>${LABELS[ti]}</label><select id="s_${di}_${ti}">`;
html+=`<option value="">--</option>`;
opts.forEach(o=>{
const sel=(current&&(current.name||current.offeringName)===o.name)?'selected':'';
html+=`<option value="${o.id}" ${sel}>${o.name}</option>`;
});
html+='</select></div>';
});
html+='</div>';
});
html+='</div>';
document.getElementById('detailTitle').textContent='Edit: '+name;
document.getElementById('detailBody').innerHTML=html;
document.getElementById('detailFooter').innerHTML='<button class="btn btn-primary" onclick="saveStudentSchedule()">Save</button><button class="btn btn-secondary" onclick="closeDetail()">Cancel</button>';
document.getElementById('detailModal').style.display='block';
}

async function saveStudentSchedule(){
if(!editingStudent)return;
const ids=[];
DAYS.forEach((day,di)=>{
TIMES.forEach((time,ti)=>{
const sel=document.getElementById(`s_${di}_${ti}`);
if(sel&&sel.value)ids.push(parseInt(sel.value));
});
});
try{
const r=await fetch(API,{method:'POST',body:JSON.stringify({
action:'saveStudentSchedule',studentName:editingStudent,offeringIds:ids
})});
const res=await r.json();
if(res.success){
msg('‚úÖ Saved','success');
closeDetail();
await loadStudents();
}else{msg('‚ùå '+res.message,'error')}
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function loadOfferings(){
try{
if(!students.length)await loadStudents();
document.getElementById('offeringsContainer').innerHTML='<div class="loading"><div class="spinner"></div></div>';
const r=await fetch(`${API}?action=loadOfferings`);
const d=await r.json();
offerings=d.offerings||[];
document.getElementById('totalOfferings').textContent=offerings.length;
const instructors=new Set(offerings.map(o=>o.instructor));
document.getElementById('totalInstructors').textContent=instructors.size;
renderOfferings();
msg('‚úÖ Loaded','success');
}catch(e){msg('‚ùå '+e.message,'error')}
}

function renderOfferings(){
const c=document.getElementById('offeringsContainer');
const search=document.getElementById('searchOfferings').value.toLowerCase();
const day=document.getElementById('filterDay').value;
let filtered=offerings.filter(o=>{
const match=!search||o.name.toLowerCase().includes(search)||o.instructor.toLowerCase().includes(search);
const matchDay=!day||o.day===day;
return match&&matchDay;
});
if(!filtered.length){c.innerHTML='<p style="text-align:center;padding:40px">No offerings</p>';return}
let html='<table><thead><tr><th>Name</th><th>Instructor</th><th style="width:80px">Day</th><th style="width:100px">Time</th><th style="width:80px">Type</th><th style="width:80px">Enrolled</th><th style="width:180px">Actions</th></tr></thead><tbody>';
filtered.forEach(o=>{
const enrolled=getEnrolled(o);
html+=`<tr><td><strong>${o.name}</strong></td><td>${o.instructor}</td><td>${o.day.slice(0,3)}</td><td style="font-size:11px">${o.time}</td>
<td><span class="badge badge-${o.type}">${o.type}</span></td>
<td><button class="btn btn-secondary btn-small" onclick="viewEnroll(${o.id})" style="background:${enrolled.length?'#4CAF50':'#999'}">
${enrolled.length}</button></td>
<td><button class="btn btn-primary btn-small" onclick="manageEnrollment(${o.id})">Manage</button>
<button class="btn btn-secondary btn-small" onclick="editOffering(${o.id})">Edit</button>
<button class="btn btn-danger btn-small" onclick="deleteOffering(${o.id})">Del</button></td></tr>`;
});
html+='</tbody></table>';
c.innerHTML=html;
}

function getEnrolled(o){
const enrolled=[];
students.forEach(s=>{
try{
const classes=JSON.parse(s.classes||'[]');
if(classes.some(c=>(c.name||c.offeringName)===o.name&&c.day===o.day&&c.time===o.time))enrolled.push(s.name);
}catch(e){}
});
return enrolled;
}

function viewEnroll(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
const enrolled=getEnrolled(o);
let html=`<div class="detail"><p><strong>${o.name}</strong> | ${o.day}, ${o.time}</p><p>Enrolled: ${enrolled.length}</p></div>`;
if(!enrolled.length){html+='<p style="text-align:center;color:#999">No students</p>'}
else{enrolled.sort().forEach(n=>{html+=`<div class="class-item">${n}</div>`})}
document.getElementById('detailTitle').textContent='Enrollment';
document.getElementById('detailBody').innerHTML=html;
document.getElementById('detailFooter').innerHTML='<button class="btn btn-primary btn-small" onclick="manageEnrollment('+id+')">Manage</button><button class="btn btn-secondary" onclick="closeDetail()">Close</button>';
document.getElementById('detailModal').style.display='block';
}

function manageEnrollment(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
const enrolled=getEnrolled(o);
let html=`<div class="detail"><p><strong>${o.name}</strong> | ${o.day}, ${o.time}</p></div><div style="max-height:400px;overflow-y:auto">`;
students.forEach(s=>{
const checked=enrolled.includes(s.name);
html+=`<div class="student-check"><input type="checkbox" id="e_${s.name}" ${checked?'checked':''}><label for="e_${s.name}">${s.name}</label></div>`;
});
html+='</div>';
document.getElementById('detailTitle').textContent='Manage Enrollment';
document.getElementById('detailBody').innerHTML=html;
document.getElementById('detailFooter').innerHTML='<button class="btn btn-primary" onclick="saveEnrollment('+id+')">Save</button><button class="btn btn-secondary" onclick="closeDetail()">Cancel</button>';
document.getElementById('detailModal').style.display='block';
}

async function saveEnrollment(offeringId){
const o=offerings.find(of=>of.id===offeringId);
if(!o)return;
const enrolled=getEnrolled(o);
for(const s of students){
const checked=document.getElementById(`e_${s.name}`)?.checked;
const wasEnrolled=enrolled.includes(s.name);
if(checked===wasEnrolled)continue;
let classes=[];
try{classes=JSON.parse(s.classes||'[]')}catch(e){}
if(checked){
classes=classes.filter(c=>!(c.day===o.day&&c.time===o.time));
classes.push({name:o.name,instructor:o.instructor,day:o.day,time:o.time});
}else{
classes=classes.filter(c=>!((c.name||c.offeringName)===o.name&&c.day===o.day&&c.time===o.time));
}
const ids=classes.map(c=>{
const match=offerings.find(of=>of.name===(c.name||c.offeringName)&&of.day===c.day&&of.time===c.time);
return match?match.id:null;
}).filter(id=>id);
try{
await fetch(API,{method:'POST',body:JSON.stringify({action:'saveStudentSchedule',studentName:s.name,offeringIds:ids})});
}catch(e){}
}
msg('‚úÖ Enrollment saved','success');
closeDetail();
await loadStudents();
}

function showAddModal(){
currentEdit=null;
document.getElementById('modalTitle').textContent='Add Offering';
document.getElementById('form').reset();
document.querySelectorAll('input[name="days"],input[name="times"]').forEach(cb=>cb.checked=false);
document.getElementById('offeringModal').style.display='block';
}

function editOffering(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
currentEdit=o;
document.getElementById('modalTitle').textContent='Edit';
document.getElementById('name').value=o.name;
const instructors=o.instructor.split(' & ');
Array.from(document.getElementById('instructor').options).forEach(opt=>opt.selected=instructors.includes(opt.value));
document.getElementById('location').value=o.location||'';
document.getElementById('type').value=o.type;
document.getElementById('capacity').value=o.capacity||'';
const related=offerings.filter(of=>of.name===o.name&&of.instructor===o.instructor);
const days=[...new Set(related.map(r=>r.day))];
const times=[...new Set(related.map(r=>r.time))];
document.querySelectorAll('input[name="days"]').forEach(cb=>cb.checked=days.includes(cb.value));
document.querySelectorAll('input[name="times"]').forEach(cb=>cb.checked=times.includes(cb.value));
if(o.level){
const levels=o.level.split(', ');
Array.from(document.getElementById('level').options).forEach(opt=>opt.selected=levels.includes(opt.value));
}
document.getElementById('offeringModal').style.display='block';
}

async function save(){
const form=document.getElementById('form');
if(!form.checkValidity()){form.reportValidity();return}
const days=Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb=>cb.value);
if(!days.length){msg('‚ö†Ô∏è Select days','error');return}
const times=Array.from(document.querySelectorAll('input[name="times"]:checked')).map(cb=>cb.value);
if(!times.length){msg('‚ö†Ô∏è Select times','error');return}
const instructors=Array.from(document.getElementById('instructor').selectedOptions).map(opt=>opt.value);
if(!instructors.length){msg('‚ö†Ô∏è Select facilitators','error');return}
const levels=Array.from(document.getElementById('level').selectedOptions).map(opt=>opt.value);
const base={
name:document.getElementById('name').value,
instructor:instructors.join(' & '),
location:document.getElementById('location').value,
type:document.getElementById('type').value,
level:levels.join(', '),
capacity:document.getElementById('capacity').value
};
try{
if(currentEdit){
const related=offerings.filter(o=>o.name===currentEdit.name&&o.instructor===currentEdit.instructor);
for(const r of related){
await fetch(API,{method:'POST',body:JSON.stringify({action:'deleteOffering',offeringId:r.id})});
}
}
for(const day of days){
for(const time of times){
const data={...base,day,time,action:'saveOffering'};
const r=await fetch(API,{method:'POST',body:JSON.stringify(data)});
const res=await r.json();
if(!res.success){msg('‚ùå '+res.message,'error');return}
}
}
msg('‚úÖ Saved','success');
closeModal();
await loadOfferings();
}catch(e){msg('‚ùå '+e.message,'error')}
}

async function deleteOffering(id){
const o=offerings.find(of=>of.id===id);
if(!o)return;
const related=offerings.filter(of=>of.name===o.name&&of.instructor===o.instructor);
if(confirm(`Delete "${o.name}"? (${related.length} entries)`)){
try{
for(const r of related){
await fetch(API,{method:'POST',body:JSON.stringify({action:'deleteOffering',offeringId:r.id})});
}
msg('‚úÖ Deleted','success');
await loadOfferings();
}catch(e){msg('‚ùå '+e.message,'error')}
}
}

function closeModal(){document.getElementById('offeringModal').style.display='none';currentEdit=null}
function closeDetail(){document.getElementById('detailModal').style.display='none'}
function msg(text,type){
const s=document.getElementById('status');
s.textContent=text;
s.className='status '+type;
s.style.display='block';
setTimeout(()=>s.style.display='none',3000);
}

window.onclick=e=>{if(e.target.classList.contains('modal'))e.target.style.display='none'}
window.onload=()=>loadStudents();
</script>
</body>
</html>
